#!/bin/sh
# Modification history
# 01b,10feb16,abd  keeping proper device name checks.
# 01a,30nov15,abd  merging the AC to super branch.

#First of all get the architechture name to assign Macros.
device_name=`cat /pfrm2.0/var/device_name`
PRODUCT_MODEL_ID=`/pfrm2.0/bin/printProductData /etc/mtdDevice ModelId |  awk '{print $1}'`
HW_VERSION=`/pfrm2.0/bin/printProductData /etc/mtdDevice HwVer |  awk '{print $1}'`
MODEL_ID=`/pfrm2.0/bin/printProductData /etc/mtdDevice ModelId |  awk '{print $1}'`
HARDWARE_FAMILY_SERIES =`cat /tmp/hwFamilyVersion | awk '{print $1}'`
PRODUCT_ID=${PRODUCT_MODEL_ID}_${HARDWARE_FAMILY_SERIES}
BASE_HARDWARE_VERSION=`echo $HARDWARE_FAMILY_SERIES | awk '{ print substr( $0, 1, 1 ) }'`
PRODUCT_ASCII_ID=${PRODUCT_MODEL_ID}_${BASE_HARDWARE_VERSION}"1"

if [ "$PRODUCT_ID" = "DSR-1000AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-500AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-1000_Bx" ] || [ "$PRODUCT_ID" = "DSR-500_Bx" ]; then
SERIAL_NUMBER=`/pfrm2.0/bin/printProductData /etc/mtdDevice SerNo |  awk '{print $1}'`
else
SERIAL_NUMBER=$(head -n 1 /proc/productData/product_serial_number);
fi

#BSP specific configuration file
MOD_SUFFIX=ko
DB_FILENAME=/tmp/system.db
STATS_DB_FILENAME=/tmp/stats.db
DB_SQL_FILENAME=/pfrm2.0/etc/system.sql
STATS_DB_SQL_FILENAME=/pfrm2.0/etc/stats.sql
INCLUDE_MIBCTL=n
#Disabling the https support in thttpd
INCLUDE_HTTPS=n
if [ "$device_name" == "DSR-150N" ];then
INCLUDE_IPS=n
fi
INCLUDE_LIGHTTPD=y
UMI_FAMILY="32"
HAVP_TEMPLATEPATH="/pfrm2.0/var/www/havp/templates/en/"
#FLASH_FIRM_PARTITION=/mnt/flash
FLASH_HTTPS_CERT="/data/tmp/https.crt"
FLASH_HTTPS_KEY="/data/tmp/https.key"
CURRENT_DATE=030400002009 #Fri Mar  4 00:00:00 GMT 2009
SERIAL=`ifconfig eth1 | grep HWaddr | awk '{print $5}'| awk -F":" '{print $4,$5,$6}' | sed 's/ //g'`
CN="dsr.dlink.com.tw"
ORGUNIT="Certificate for DSR (Self-Signed)"
RNAME="D-Link"
COUNTRY="TW"
CERT_KEY_LENGTH=2048
STATE="Taiwan"
LOCALITY="Taipei"
FLASH_CONFIG_PART=/dev/mtd3
FLASH_CONFIG_FILE=/tmp/teamf1.cfg.ascii
DEFAULT_CONFIG_FILE=/pfrm2.0/etc/teamf1.cfg.defaults.ascii
RUNTIME_CONFIG_FILE=/tmp/teamf1.cfg.ascii
FACTORY_RESET_SCRIPT="/pfrm2.0/bin/factoryReset.sh"
RESTORE_ON_CONFIG_VERSION_MISMATCH=1
USERDB_SETUP_PASSWD=n
DOT11_IAPP_INTERFACE=bdg
DOT11_ATH_RATE=atheros
DOT11_ATHEROS_DRIVER=fusion
ORGNAME="D-Link Corporation"
DOT11_FUSION_TX_BUFS=0
DOT11_FUSION_RX_BUFS=0

# set the max conntrack limits.
if [ "$PRODUCT_MODEL_ID" == "DSR-1000AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000N" ]; then
    NF_CONNTRACK_MAX=100000
elif [ "$PRODUCT_MODEL_ID" == "DSR-500AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500N" ]; then
    NF_CONNTRACK_MAX=50000
elif [ "$PRODUCT_MODEL_ID" == "DSR-250N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-250" ]; then
    NF_CONNTRACK_MAX=20000
elif [ "$PRODUCT_MODEL_ID" == "DSR-150N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-150" ]; then
    NF_CONNTRACK_MAX=10000
else
    NF_CONNTRACK_MAX=60000
fi



BOARD_CONFIG_FILE=/tmp/dummy.file
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib/gcc/mips64-octeon-linux-gnu/glibc_2.3.3-header_2.6.16.26-gcc_4.1.2/


#For creating X509 Self Signed Certificate
CERT_FLASH=$FLASH_HTTPS_CERT
KEY_FLASH=$FLASH_HTTPS_KEY

# For sslvpnInit
#WAN_IF_NAME="eth0"
#WAN_DUMMY_IP="10.0.0.1"

COMPANY_NAME="D-link"
if [ "$PRODUCT_ID" = "DSR-1000AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-500AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-1000_Bx" ] || [ "$PRODUCT_ID" = "DSR-500_Bx" ]; then
    UNIT_NAME=$ORGUNIT
    COPYRIGHTS="&#169; 2015 Dlink, Inc. All rights reserved."
    COPYRIGHTS_BASE="2015 Dlink, Inc."
    BUILD_DATE=`cat /pfrm2.0/etc/firmBuildDate`
    INCLUDE_MGMT_COMPONENT=y
else
    UNIT_NAME=$device_name
    COPYRIGHTS="&#169; 2014 Dlink, Inc. All rights reserved."
    COPYRIGHTS_BASE="2014 Dlink, Inc."
    INCLUDE_MGMT_COMPONENT=n
fi

#COPYRIGHTS_VENDOR="&#169; 2009 Trend Micro Incorporated. All rights reserved."
PRODUCT_HOME_URL=www.dlink.com
PRODUCT_SUPPORT_URL=www.dlink.com
SSL_MAX_USER_SESSION_LIMIT="20"

# set countrycode and supportedmodes
DOT11_COUNTRY_CODE=`/pfrm2.0/bin/printProductData /etc/mtdDevice RegInfo  | awk '{print $1}'`

# Max SSL VPN tunnel limits

if [ "$PRODUCT_MODEL_ID" == "DSR-150N" ] || [ "$device_name" == "DSR-150" ];then
    SSL_MAX_TUNNEL_LIMIT="5"
elif [ "$PRODUCT_MODEL_ID" == "DSR-250N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-250" ]; then
    SSL_MAX_TUNNEL_LIMIT="10"
elif [ "$PRODUCT_MODEL_ID" == "DSR-500AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500" ]; then
    SSL_MAX_TUNNEL_LIMIT="15"
elif [ "$PRODUCT_MODEL_ID" == "DSR-1000AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000" ]; then
    SSL_MAX_TUNNEL_LIMIT="25"
else 
    SSL_MAX_TUNNEL_LIMIT="20"
fi

if [ -e "/data/tmp/teamf1.cfg.ascii" ]; then
    CFG_FILE=/data/tmp/teamf1.cfg.ascii
else
    CFG_FILE=/pfrm2.0/etc/teamf1.cfg.defaults.ascii
fi

rm -rf /var/teamf1.cfg.defaults.ascii
cp $DEFAULT_CONFIG_FILE /var/teamf1.cfg.defaults.ascii
DEFAULT_CONFIG_FILE=/var/teamf1.cfg.defaults.ascii 

if [ "$PRODUCT_ID" = "DSR-1000AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-500AC_Ax" ] || [ "$PRODUCT_ID" = "DSR-1000_Bx" ] || [ "$PRODUCT_ID" = "DSR-500_Bx" ]; then
    # Append device specific ascii files
    #if [ -e "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_ID.ascii" ]; then
     #   cat "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_ID.ascii" >> $DEFAULT_CONFIG_FILE 
     if [ -e "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_ASCII_ID.ascii" ]; then
       cat "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_ASCII_ID.ascii" >> $DEFAULT_CONFIG_FILE 
    fi
else
    # Append device specific ascii files
    if [ -e "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_MODEL_ID.ascii" ]; then
        cat "/pfrm2.0/etc/teamf1.cfg.defaults.$PRODUCT_MODEL_ID.ascii" >> $DEFAULT_CONFIG_FILE 
    fi
fi

if [ "$PRODUCT_MODEL_ID" == "DSR-500N" ]; then
DOT11_SUPPORTED_WMODES=0x6e2c   # exclude 5G modes
else
DOT11_SUPPORTED_WMODES=0x1fe6f  # all modes
fi
# For Japan, we are re-mapping the code to match the latest regulatory revisions (updated n-mode support)
if [ $DOT11_COUNTRY_CODE == "392" ]; then                                              
    DOT11_COUNTRY_CODE="4015"                                                       
fi
DOT11_ATH_DEV_MOD_PARAMS="countrycode=$DOT11_COUNTRY_CODE supportedmodes=$DOT11_SUPPORTED_WMODES disableDfs=1"

# disable dot11 framework init. if wireless is not required
if [ "$PRODUCT_MODEL_ID" == "DWC-1000" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500" ] || [ "$PRODUCT_MODEL_ID" == "DSR-150" ] || [ "$PRODUCT_MODEL_ID" == "DSR-250" ]; then
INCLUDE_DOT11="n"
fi

#for ipsec
CONFIG_VPNKAD=y
CONFIG_RVGD=y
INCLUDE_AUTH_DAEMON_SUPPORT=y
AUTO_L2TP_IPSEC=y 
#for accounting
INCLUDE_ACCOUNTING=n
mkdir -p /var/clish
if [ "$PRODUCT_MODEL_ID" == "DSR-1000AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-1000" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500AC" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500N" ] || [ "$PRODUCT_MODEL_ID" == "DSR-500" ]; then
INCLUDE_ACCOUNTING=y
    echo Y > /var/clish/Radius-Accounting-Settings
    echo Y > /var/clish/Radius-Accounting-Server-Settings
    echo Y > /var/clish/nas-iface
else
    echo N > /var/clish/Radius-Accounting-Settings
    echo N > /var/clish/Radius-Accounting-Server-Settings
    echo N > /var/clish/nas-iface
fi

