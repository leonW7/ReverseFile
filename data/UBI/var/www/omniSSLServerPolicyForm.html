<?lua
require "teamf1lualib/openVpnServerPolicy_bl"
require "teamf1lualib/errorMap"
require "teamf1lualib/returnCodes"

local openVpnServerPolicy = require("com.teamf1.bl.vpn.openVpnServerPolicy")
local errorMap    = require ("com.teamf1.core.errorMap")
local returnCodes = require ("com.teamf1.core.returnCodes")
local policyOwnerName1, policyOwnerName2

if(ButtonType == "add" or ButtonType == "edit") then
    if (cgi["configRowId"] ~= "-1") then
        configRowId = cgi["configRowId"]
        returnCode, cookie, policyName, policyType, policyOwnerName, 
        policyDestinationType, permission, destination, 
        IPAddress, maskLength, startPort, endPort, icmp  = openVpnServerPolicy.openVpnServerPolicySectionGetCur(configRowId)
	policyOwnerName1 = policyOwnerName
	policyOwnerName2 = policyOwnerName 
        
        returnCode1, groupRow = openVpnServerPolicy.groupsGet()
	returnCode2, userRow = openVpnServerPolicy.usersGet()
        
	if(returnCode ~= returnCodes.SUCCESS) then
        	statusErrorMessage = errorMap.errorStringGet (returnCode)
    	elseif(returnCode1 ~= returnCodes.SUCCESS) then
        	statusErrorMessage = errorMap.errorStringGet (returnCode1)
    	elseif(returnCode2 ~= returnCodes.SUCCESS) then
        	statusErrorMessage = errorMap.errorStringGet (returnCode2)
    	end
else
        configRowId = "-1"
        policyType,policyDestinationType,permission, 
        policyOwnerName1, policyOwnerName2 = openVpnServerPolicy.openVpnServerPolicySectionDefaultsGet ()

        returnCode1, groupRow = openVpnServerPolicy.groupsGet()
        returnCode2, userRow = openVpnServerPolicy.usersGet()
       
	 if(returnCode1 ~= returnCodes.SUCCESS) then
        	statusErrorMessage = errorMap.errorStringGet (returnCode1)
        elseif(returnCode2 ~= returnCodes.SUCCESS) then
        	statusErrorMessage = errorMap.errorStringGet (returnCode2)
        end 
end
cgilua.header ("Content-Type", "text/html; charset=UTF-8")
?>

<div id="tf1_omniSSLServerPolicyDailogContent">
				<div class="topBg">
					<h1 data-localize="50017">OmniSSL Server Policies Configuration</h1>
					<close>
						<a href="#" id="btnClose" title="Close">X</a>
					</close>
				</div>
				 
				<div class="dialogMidArea">

			        <?lua if (cgi["configRowId"] == "-1") then ?>
					<div class="configRow">
						<label data-localize="12459">Policy Type</label>
					
						<p>
							<input type="radio" value="1" $| web.radioSelected(policyType == "1") |$ id="tf1_portalLayout1" onClick="policyTypeCheck('tf1_portalLayout1')" name="omniSSLServerPolicy.policyType">
                            <span data-localize="11069">Global</span>
						</p>
						<p>
							<input type="radio" value="3" $| web.radioSelected(policyType == "3") |$ id="tf1_portalLayout3" onClick="policyTypeCheck('tf1_portalLayout3')" name="omniSSLServerPolicy.policyType">
                            <span data-localize="13234">User</span>
						</p> 
					                   </div>
                    <div class="break" id="break1_div">
                        &nbsp;
                    </div>
				<?lua else
					local modpolicyType, modpolicyDestinationType, locModType, locDestType
					if (policyType == "1") then
						modpolicyType = "Global"
                        locModType = "data-localize='11069'"
					elseif (policyType == "2") then
                                		modpolicyType = "Group"
                                        locModType = "data-localize='11082'"
					elseif (policyType == "3") then
                                		modpolicyType = "User"
                                        locModType = "data-localize='13234'"
					end 
                            		if (policyDestinationType == "1") then
                                		modpolicyDestinationType = "IP Address"
                                        locDestType = "data-localize='11387'"
                            		elseif (policyDestinationType == "2") then
                                		modpolicyDestinationType = "IP Network"
                                        locDestType = "data-localize='14097'"
                            	         end?>
                       
                    		<div class="configRow">
                        		<label data-localize="14100">Policy For</label>
					<p $| locModType |$>$| modpolicyType |$</p>
                        		<input type="hidden" name="omniSSLServerPolicy.policyType" value="$| policyType or '' |$" >
                    		</div>
                    		<div class="break" id="break6_div">
                        		&nbsp;
                    		</div>
							<div class="configRow">
                            	<label data-localize="14099">Policy Owner Name</label>
								<p>$| policyOwnerName |$</p>
                            	<input type="hidden" name="omniSSLServerPolicy.policyOwnerName" value="$| policyOwnerName or '' |$" >
                        	</div>
                        	<div class="break" id="break6_div">
                            	&nbsp;
                        	</div>
                   	 		<div class="configRow" id="tf1_applyPolicy_div">
                        		<label data-localize="10278">Apply Policy to</label>
								<p $| locDestType |$>$| modpolicyDestinationType |$</p>
                        		<select style="display:none" size="1" id="tf1_applyPolicy" name="omniSSLServerPolicy.policyDestinationType" onChange="applyPolicyToType('tf1_applyPolicy')">
                            		<option data-localize='11387' $| web.dropdownSelected(policyDestinationType == "1") |$ value="1">IP Address</option>
                            		<option data-localize='14097' $| web.dropdownSelected(policyDestinationType == "2") |$ value="2">IP Network</option>
                        		</select>
                    		</div>
                   
                    		<div class="break" id="break4_div">
                        		&nbsp;
                    		</div>
				<?lua end ?>
				<?lua if (cgi["configRowId"] == "-1") then ?>
					<div class="configRow" id="tf1_availableGroups_div">
						<label data-localize="10341">Available Groups</label>
						<select name="omniSSLServerPolicy.policyOwnerName1">
				 	<?lua
                				for k, v in pairs(groupRow) do
                					local outputTable = {}
                					outputTable = groupRow[k]
                					local groupName = outputTable["UserGroups.GroupName"]
             				?>
             			<option value="$|groupName|$" $| web.radioSelected(policyOwnerName1 == groupName) |$>$|groupName|$</option>

					<?lua end?>
						</select>
						</div>
					<div class="break" id="break2_div">
						&nbsp;
					</div>
					<div class="configRow" id="tf1_availableUsers_div">
						<label data-localize="10344">Available Users</label>
						<select name="omniSSLServerPolicy.policyOwnerName2" id="tf1_availUsers">
						<?lua
                            				for k, v in pairs(userRow) do
                            					local outputTable1 = {}
                            					outputTable1 = userRow[k]
                            					local userName = outputTable1["Users.UserName"]
                        			?>                        
                        <option value="$|userName|$" $| web.radioSelected(policyOwnerName2 == userName) |$>$|userName|$</option>
                        			<?lua end?>
						</select>
						</div>
					<div class="break" id="break3_div">
						&nbsp;
					</div>
					<h2 data-localize="50018">OmniSSL Policy</h2>
					<div class="configRow" id="tf1_applyPolicy_div">
						<label data-localize="10278">Apply Policy to</label>
						<select size="1" id="tf1_applyPolicy" name="omniSSLServerPolicy.policyDestinationType" onChange="applyPolicyToType('tf1_applyPolicy')">
							<option data-localize='11387' value="1" $| web.dropdownSelected(policyDestinationType == "2") |$>IP Address</option>
							<option data-localize='14097' value="2" $| web.dropdownSelected(policyDestinationType == "3") |$>IP Network</option>
						</select>
					</div>
				
					<div class="break" id="break4_div">
						&nbsp;
					</div>
					<?lua end ?>
					<div class="configRow" id="tf1_txtPolicyName_div">
						<label data-localize="12458">Policy Name</label>

            <?lua if (ButtonType == "edit") then
            ?>
              <input type="hidden" id="tf1_txtPolicyName" name="omniSSLServerPolicy.policyName" value="$| policyName or '' |$" ><p>$| policyName or '' |$</p>
            <?lua else ?>
<input type="text" id="tf1_txtPolicyName" name="omniSSLServerPolicy.policyName" value="$| policyName or '' |$" >
            <?lua end?>
					</div>
					<div class="break" id="break5_div">
						&nbsp;
					</div>
				
					<div class="configRow" id="tf1_txtIPAddress_div">
						<label data-localize='11387'>IP Address</label>
						<input type="text" name="omniSSLServerPolicy.IPAddress" value="$| IPAddress or '' |$" id="tf1_txtIPAddress" maxlength="15" onKeyPress="return numericValueCheck (event, '.')" onKeyDown="if (event.keyCode == 9) { return ipAddrCheck(); }">
					</div>
					<div class="break" id="break6_div">
						&nbsp;
					</div>
					<div class="configRow" id="tf1_txtMaskLen_div">
						<label data-localize="11684">Mask Length</label>
						<input type="text" name="omniSSLServerPolicy.maskLength" value="$| maskLength or '' |$" class="one" maxlength="2" id="tf1_txtMaskLen" onKeyPress="return numericValueCheck (event)" onKeyDown="if (event.keyCode == 9) {return numericValueRangeCheck (this, '', '', 0, 32, true, '', '');}">
						<dl>
                            [<span data-localize="12627">Range</span>: 0 - 32]
						</dl>
					</div>
					<div class="break" id="break7_div">
						&nbsp;
					</div>
					<div class="configRow" id="tf1_icmpCheck_div">
						<label data-localize="11134">ICMP</label>
                        <?lua 
                                                 
                             if (icmp == "1") then
                                statusStr="enable-disable-on"
                                statusVar = "1"
                             else
                                statusStr="enable-disable-off"
                                statusVar = "0"
                              end
                        ?>
						<a class="$| statusStr |$" alt="" id="tf1_icmpCheck"></a>                                            
                        <input type="hidden" name="omniSSLServerPolicy.icmp" value="$| statusVar |$">
					</div>
					<div class="break" id="break_icmpCheck_div">
						&nbsp;
					</div>
					<h2 data-localize="50019">Port Range / Port Number</h2>
					<div class="configRow" id="tf1_txtStrPort_div">
						<label data-localize="10374">Begin</label>
						<input type="text" name="omniSSLServerPolicy.startPort" value="$| startPort or '' |$" class="one" maxlength="5" id="tf1_txtStrPort" onKeyPress="return numericValueCheck (event)" onKeyDown="if (event.keyCode == 9) {return numericValueRangeCheck (this, '', '', 0, 65535, true, '', '');}">
						<dl>
							[<span data-localize="12627">Range</span>: 0 - 65535]
						</dl>
					</div>
					<div class="break" id="break8_div">
						&nbsp;
					</div>
					<div class="configRow" id="tf1_txtEndPort_div">
						<label data-localize="10919">End</label>
						<input type="text" name="omniSSLServerPolicy.endPort" value="$| endPort or '' |$" class="one" maxlength="5" id="tf1_txtEndPort" onKeyPress="return numericValueCheck (event)" onKeyDown="if (event.keyCode == 9) {if (numericValueRangeCheck (this, '', '', 0, 65535, true, '', '') == true) {return checkPortRange ('txtStrPort','txtEndPort');} else {return false;}}">
						<dl>
							[<span data-localize="12627">Range</span>: 0 - 65535]
						</dl>
					</div>
					<div class="break" id="break9_div">
						&nbsp;
					</div>
									<div class="configRow" id="tf1_permission_div">
						<label data-localize="11933">Permission</label>
						<p>
							<input type="radio" $| web.radioSelected(permission == "Permit") |$ value="Permit" name="omniSSLServerPolicy.permission">
                            <span data-localize="11934">Permit</span>
						</p>
						<p>
							<input type="radio" $| web.radioSelected(permission == "Deny") |$ value="Deny" name="omniSSLServerPolicy.permission" >
                            <span data-localize="10699">Deny</span>
						</p>
					</div>
					<div class="break">
						&nbsp;
					</div>
				</div>
				<div class="dialogSubmitRow">
					<input data-localize="12758" type="submit" name="button.config.omniSSLServerPolicy.omniSSLServerPolicy.$| configRowId |$" onclick="return omniSSLPoliciesValidate('tf1_frmomniSSLServerPolicy')" class="btnSubmit" title="Save" value="Save" id="btSave">
				</div>
			</div>
<?lua end?>
