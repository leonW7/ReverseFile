<?lua
require "teamf1lualib/captivePortal"


-- Check if User is already Logged in
	-- If already logged in make spUrlStr 1

	local alreadyLoggedIn = captivePortal.getLoginStatus ()
	if(alreadyLoggedIn == "1" ) then
	    spUrlStr = "1"
	end

-- if login button
if(spUrlStr=="1") then
	spUrlStrFinal="1"
else
	spUrlStrFinal="0"
    end

local isenabled,profileId,vlanId, clientType, accessType = captivePortal.isEnabled ()
if (ButtonType and ButtonType == "login") then   
	local valid, statusCode = captivePortal.slaRunTimelogin(vlanId, clientType)		
	if(valid) then
		spUrlStr = "1"
		statusMessage=statusCode or ''
		web.goToPage(NextPage, true, true)
	end
elseif (ButtonType and ButtonType == "logout") then
    -- go to next page - which will be login page
    spUrlStr = "0"
    captivePortal.RunTimelogout()
    if (clientType ~= CaptivePortal.LAN_CLIENT) then
        os.execute("sleep " .. tonumber(1))
        local wher = "LogicalIfName ='LAN' and AddressFamily = 2"
        local lanIPRow = db.getRowWhere ("ifStatic", wher)
        local lanIP = lanIPRow["ifStatic.StaticIp"] 
        cgilua.redirect ("http://" .. lanIP .."/scgi-bin/platform.cgi?page=slaLogin.html")
    else
        web.goToPage(NextPage, true, true)
        end
        elseif (isenabled == "0") then
    NextPage = "index"
    cpStatusMsg = ""
    web.goToPage(NextPage, true, true) 
  elseif (isenabled == "1" and (accessType == "2" or accessType == "3")) then
        local wher = "LogicalIfName ='LAN' and AddressFamily = 2"
        local lanIPRow = db.getRowWhere ("ifStatic", wher)
        local lanIP = lanIPRow["ifStatic.StaticIp"] 
        cgilua.redirect ("http://" .. lanIP .."/scgi-bin/platform.cgi?page=captivePortal.html")

else
	local slaRules, broserTitle=captivePortal.getslaRules(profileId)
?>
<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<title>$| broserTitle |$</title>
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="" rel="stylesheet" type="text/css" media="all" />
<link rel="shortcut icon" href="images/favicon.png?page=mslaLogin.html" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js?page=mslaLogin.html"></script>
<style>
a, article, audio, body, body, canvas, caption, dd, details, div, dl, dt, em, figcaption, figure, footer, form, h1, h2, h3, h4, h5, header, html, i, iframe, img, label, legend, li, mark, menu, nav, object, ol, p, q, samp, section, small, span, strong, sub, summary, table, tbody, td, textarea, tfoot, th, thead, time, tr, ul, var, video {
	border: 0 none;
	font-family: "Trebuchet MS", Arial, Verdana, Helvetica, Sans-serif;
	margin: 0;
	padding: 0;
}
body {
	background-color: #EAEAEA;
	color: #006699;
	font-size: 12px;
}
.wrapper {
	margin: 0 auto;
	width: 100%;
}
.header {
	background: url("images/headerBg.png?page=mslaLogin.html") repeat-x scroll 0 0 transparent;
	min-height: 100px;
	text-align: center;
}
.logo {
	background: url("images/logo.png?page=mslaLogin.html") no-repeat scroll 10px 16px transparent;
	color: #86C2FD;
	font-size: 14px;
	letter-spacing: 1px;
	padding: 54px 10px 10px;
	text-align: left;
}
.btnLogout > div > div {
 filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr='#64b1d9', EndColorStr='#1876a6');
	background:#1876a6;
	background:-ms-linear-gradient(top, #64b1d9, #1876a6);
	background:-webkit-gradient(linear, left top, left bottom, from(#64b1d9), to(#1876a6));
	background:-moz-linear-gradient(top, #64b1d9, #1876a6);
	background:-o-linear-gradient(top, #64b1d9, #1876a6);
	color: #FCFCFC;
	font-size: 12px;
	height: 100%;
	line-height: 24px;
	padding: 0 8px;
}
.btnLogout {
	float: right;
	cursor: default;
	text-decoration: none;
	margin: 15px 15px 0 0;
	border: 2px solid #FEFEFE;
	border-radius: 2px 2px 2px 2px;
	padding: 0;
}
.footer {
 filter: progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr='#919191', EndColorStr='#2F2F2F');
	background:#919191;
	background:-ms-linear-gradient(top, #919191, #2F2F2F);
	background:-webkit-gradient(linear, left top, left bottom, from(#919191), to(#2F2F2F));
	background:-moz-linear-gradient(top, #919191, #2F2F2F);
	background:-o-linear-gradient(top, #919191, #2F2F2F);
	bottom:0px;
	color: #FFFFFF;
	font-size: 10px;
	letter-spacing: 1px;
	left:0px;
	line-height: 29px;
	text-align: center;
	margin: 20px 0 0;
	position:fixed;
	width: 100%;
}
.midArea {
	background: none repeat scroll 0 0 #FFFFFF;
	border-radius: 8px 8px 8px 8px;
	box-shadow: 0 0 6px #999999;
	-moz-box-shadow: 0 0 6px #999999;
	-webkit-box-shadow: 0 0 6px #999999;
	clear: both;
	margin: 0 25px 25px 25px;
	min-height: 125px;
	padding: 25px;
	width: auto;
}
.configRow {
	padding: 0 5px;
}
.configRow > label {
	color: #333333;
	float: left;
	font-size: 12px;
	letter-spacing: 0.1em;
	line-height: 22px;
	min-width: 49%; 
	text-align: left;
}
.configRow > p {
	color: #333333;
	float: left;
	font-weight: bold;
	font-size: 12px;
	letter-spacing: 0.1em;
	line-height: 22px;
	min-width: 49%;
	padding: 0 0 0 10px;
	text-align: left;
}
.FL {
	float: left;
}
.FR {
	float: right;
}
.btn {
 filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr='#64b1d9', EndColorStr='#1876a6');
	background:#1876a6;
	background:-ms-linear-gradient(top, #64b1d9, #1876a6);
	background:-webkit-gradient(linear, left top, left bottom, from(#64b1d9), to(#1876a6));
	background:-moz-linear-gradient(top, #64b1d9, #1876a6);
	background:-o-linear-gradient(top, #64b1d9, #1876a6);
	border: 2px solid #FEFEFE!important;
	border-radius: 2px 2px 2px 2px!important;
	box-shadow: 0 0 6px #999999;
	color: #FCFCFC!important;
	cursor: pointer;
	font-size: 14px!important;
	letter-spacing: 1px!important;
	height: 28px !important;
	line-height: 28px!important;
	padding: 0px 12px!important;
	text-align: center!important;
	min-width: 70px!important;
	text-decoration: none;
    }

    
    .btn2 {
 filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr='#64b1d9', EndColorStr='#1876a6');
	background:#1876a6;
	background:-ms-linear-gradient(top, #64b1d9, #1876a6);
	background:-webkit-gradient(linear, left top, left bottom, from(#64b1d9), to(#1876a6));
	background:-moz-linear-gradient(top, #64b1d9, #1876a6);
	background:-o-linear-gradient(top, #64b1d9, #1876a6);
	border: 2px solid #FEFEFE!important;
	border-radius: 2px 2px 2px 2px!important;
	box-shadow: 0 0 6px #999999;
	color: #FCFCFC!important;
	cursor: pointer;
	font-size: 14px!important;
	letter-spacing: 1px!important;
	height: 28px !important;
	line-height: 28px!important;
	padding: 0px 12px!important;
	text-align: center!important;
	min-width: 140px!important;
	text-decoration: none;
}

.hide {

    display:none;
}

.submitRow {
	padding-left: 33%;
}
.break {
	clear: both;
	line-height: 8px;
}
.configRow > p {
	color: #006699;
	letter-spacing: 1px;
	min-width: 0;
}
.configRow > input, select, textarea {
	border: 1px solid #999999;
	color: #006699;
	float: left;
	font-size: 11px;
	height: 16px;
	letter-spacing: 1px;
	padding: 2px 4px;
	min-width: 125px;
}
h1 {
	color: #006699;
	float: left;
	font-size: 16px;
	font-weight: normal;
	letter-spacing: 1px;
	margin: 25px 0 0 0;
	padding: 0 0 10px 25px;
	text-align: left;
	width: 100%;
}
.loginPage {
	overflow: hidden;
    clear: both;
    margin-bottom: 25px;
}
.mSlaLogin {
	background: #f1f1f1;
	color: #333333;
	height: 275px;
	margin: 0 auto;
	overflow: auto;
	padding: 10px;
	text-align: justify;
	width: auto;
}
table {
	height: 100%;
	margin: 0 auto;
	padding-bottom: 20px;
	padding :0px;
	width: 100%;
}
.loginDiv {
	height:100%;
	margin:0 auto;
	width:100%;
}
.configLogin {
	padding: 0;
	margin: 0;
}

.midWidth { 
    width: 98%;
}

div.msgError, div.msgInfo, div.msgSuccess { color: #FFFFFF; font-size: 16px;
    letter-spacing: 1px; padding: 12px; min-width: 50%; width:90%;
	-moz-border-radius: 6px 6px 6px 6px;
	-webkit-border-radius: 6px 6px 6px 6px;
    border-radius: 6px 6px 6px 6px;
    margin: 3px auto;
}
div.msgError {
	filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0,StartColorStr='#ff9999',EndColorStr='#ff0202');
	background:#ff9999;
	background:-ms-linear-gradient(top,#ff9999,#ff0202);
	background:-webkit-gradient(linear,left top,left bottom,from(#ff9999),to(#ff0202));
	background:-moz-linear-gradient(top,#ff9999,#ff0202);
	background:-o-linear-gradient(top,#ff9999,#ff0202);
}
div.msgInfo {
	filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0,StartColorStr='#0096af',EndColorStr='#045d93');
	background:#0096af;
	background:-ms-linear-gradient(top,#0096af,#045d93);
	background:-webkit-gradient(linear,left top,left bottom,from(#0096af),to(#045d93));
	background:-moz-linear-gradient(top,#0096af,#045d93);
	background:-o-linear-gradient(top,#0096af,#045d93);
}
div.msgSuccess {
	filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0,StartColorStr='#32af00',EndColorStr='#95f931');
	background:#32af00;
	background:-ms-linear-gradient(top,#32af00,#95f931);
	background:-webkit-gradient(linear,left top,left bottom,from(#32af00),to(#95f931));
	background:-moz-linear-gradient(top,#32af00,#95f931);
	background:-o-linear-gradient(top,#32af00,#95f931);
}

div.msgError > p, div.msgInfo > p, div.msgSuccess > p {
 background: url("images/play.gif?page=mslaLogin.html") no-repeat scroll 0 1px transparent;
 line-height: 18px;
 padding-left: 10px;
 text-align: center;
}
</style>
<?lua web.includeMenu("metaInclude.html")?>
</head>

<body>

<div class="wrapper">
	<div class="header">
		<div class="logo FL">
			Unified Services Router - $| UNIT_NAME |$</div>
		</div>
        <div class="loginPage">
            <?lua if ( (spUrlStrFinal ~= "0") and
                                        (statusMessage ~= nil and statusMessage
                                        ~= '')) then ?>
										  <div class="blank">
                      	&nbsp;
                      </div>
											<div class="msgSuccess">
		                  	<p>$| statusMessage |$</p>
		                  </div>
											<div class="blank">
                      	&nbsp;
                      </div>
										<?lua end ?>

        <?lua if(spUrlStrFinal=="0") then ?>
        <h1>SLA Login</h1>

		<div class="midArea">
			<div class="configLogin">
                <form method="post" action="platform.cgi?page=mslaLogin.html">
                    <input type="hidden" name="thispage" value="mslaLogin.html" >
					<div class="break">
&nbsp; </div>
					<div class="mSlaLogin">
						<p>$| slaRules or '' |$</p>
					</div>
					<div class="break">&nbsp; </div>
										<p align="center"><input type="checkbox"
                                        onclick="if (this.checked == false) {$('#tf1_btnLogin').attr('disabled','disabled')} else{ $('#tf1_btnLogin').removeAttr('disabled')}">I Accept to Terms 
						&amp; Service</p>
										<div class="break">&nbsp; </div>
										<p align="center">
						<input type="submit" disabled name="button.login.mslaLogin" value="Login" title="Login" class="btn" id="tf1_btnLogin"></p>
				
					<div class="break">&nbsp; </div>
				</form>
            </div>
            <?lua elseif(spUrlStrFinal=="1") then ?>
			<!-- Screen Two-->
			<h1>Loggedin Message</h1>
			<div class="midArea">
                <div class="configLogin">
                     <form method="post" action="platform.cgi?page=mslaLogin.html">
                    <input type="hidden" name="thispage" value="mslaLogin.html" >

						<div class="break">&nbsp; </div>
						<p align="center">Succesfully Logged in!</p>
						<div class="break">&nbsp; </div>
					
							<p align="center">
							<input type="submit" name="button.logout.CaptivePortalSession.mslaLogin" value="Logout" title="Logout" class="btn"></p>
											<div class="break">&nbsp; </div>
					</form>
				</div>
                </div>
                <?lua end ?>

		</div>
		<div class="footer">
			$| COPYRIGHTS |$ </div>
	</div>
</div>

</body>

</html>
<?lua end ?>
