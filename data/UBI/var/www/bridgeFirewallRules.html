<?lua

require "teamf1lualib/bridgeFirewallRules_bl"
require "teamf1lualib/errorMap"
require "teamf1lualib/returnCodes"

	PAGE_HELP = "security"
	PAGE_HELP_SECTION = "bridgeFirewallRules"

local returnCodes = require ("com.teamf1.core.returnCodes")
local errorMap = require("com.teamf1.core.errorMap")
local errorFlag

if (ButtonType and ButtonType == "delete") then
        local inputTable = web.cgiToLuaTable(cgi)
        if(type(cgi["bridgeFirewallRules.checkbox"]) == "string") then
                inputTable["bridgeFirewallRules.cookie"] = cgi["bridgeFirewallRules.checkbox"]
                errorFlag = l2FirewallRules.delete (inputTable)
        elseif (type(cgi["bridgeFirewallRules.checkbox"]) == "table") then
                errorFlag = l2FirewallRules.deleteAll ()
        end
        if (errorFlag == returnCodes.SUCCESS) then 
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else 
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)
        
elseif (ButtonType and ButtonType == "add") then
        local inputTable = web.cgiToLuaTable(cgi)
        errorFlag, cookie = l2FirewallRules.config (inputTable)
        if (errorFlag == returnCodes.SUCCESS) then 
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else 
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)

elseif (ButtonType and ButtonType == "edit") then
        local inputTable = web.cgiToLuaTable(cgi)
        inputTable["bridgeFirewallRules.cookie"] = cgi["configRowId"]
        errorFlag, cookie = l2FirewallRules.set (inputTable)
        if (errorFlag == returnCodes.SUCCESS) then 
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else 
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)

elseif (ButtonType and ButtonType == "disable") then
        local inputTable = web.cgiToLuaTable(cgi)
        if(type(cgi["bridgeFirewallRules.checkbox"]) == "string") then
                inputTable["bridgeFirewallRules.cookie"] = cgi["bridgeFirewallRules.checkbox"]
                errorFlag = l2FirewallRules.disable (inputTable)
        elseif (type(cgi["bridgeFirewallRules.checkbox"]) == "table") then
                errorFlag = l2FirewallRules.disableAll ()
        end
        if (errorFlag == returnCodes.SUCCESS) then 
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else 
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)

elseif (ButtonType and ButtonType == "enable") then
        local inputTable = web.cgiToLuaTable(cgi)
        if(type(cgi["bridgeFirewallRules.checkbox"]) == "string") then
                inputTable["bridgeFirewallRules.cookie"] = cgi["bridgeFirewallRules.checkbox"]
                errorFlag = l2FirewallRules.enable (inputTable)
        elseif (type(cgi["bridgeFirewallRules.checkbox"]) == "table") then
                errorFlag = l2FirewallRules.enableAll ()
        end
        if (errorFlag == returnCodes.SUCCESS) then 
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else 
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)

else
    local bridgeFirewallTbl
     errorFlag, bridgeFirewallTbl = l2FirewallRules.listGet ()
    if (errorFlag ~= returnCodes.SUCCESS) then
       statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
if (bridgeFirewallTbl == nil) then
    bridgeFirewallTbl = {}
end
cgilua.header ("Content-Type","text/html; charset=UTF-8")

LANG_LOCALE =
"30315,11452,30316,30293,10747,12831,10056,13453,14197,13454,14043,30471,30486,10226,10132,30295,30152,30153,12900,13712,13713,11043,10711,30298,30503,30300,30299,30301,30302,30303,30304,30305,30306,30307,30308,12795,10862,10875,10749,10695,13004,13105"
?>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Language" content="en-us">
        <title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
<!--
Copyright (c) 2012 - 2013 TeamF1, Inc. (www.TeamF1.com)
All rights reserved.
-->
        <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="css/style.css" />
        <link rel="stylesheet" type="text/css" href="css/buttons.css" />
        <link rel="stylesheet" type="text/css" href="css/menu.css" />
        <link rel="stylesheet" type="text/css" href="css/table.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.4.custom.css" />
        <script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
        <?lua web.includeMenu("metaInclude.html")?>
    </head>
    <body>
        <!-- Section for Pop up dialog starts -->
        <div id="tf1_overlay" class="configDialogMask"></div>                
        <form action="platform.cgi" method="post" name="tf1_frmBridgeFirewallRules" id="tf1_frmBridgeFirewallRules">        
            <input type="hidden" name="thispage" id="thispage" value="bridgeFirewallRules.html">            
            <div id="tf1_dialog" class="configDialog"></div>        
        </form>        
        <!-- Section for Pop up dialog ends -->
        <table border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td class="header" valign="top" align="center">
                <?lua web.includeMenu("header.html")?></td>
            </tr>
        <!-- Right click Div Start -->
        <div class="contextMenu" id="contextMenu">
            <ul>
                <li>
                    <input id="optionSelectAll" type="checkbox" onclick="setSelectAll (this.id, 'edit');"/>
                    &nbsp;$| LANG_LOCALE['12795'] |$
                </li>
                <li id="edit">
                    $| LANG_LOCALE['10862'] |$
                </li>
                <li id="enable">
                    $| LANG_LOCALE['10875'] |$
                </li>
                <li id="disable">
                    $| LANG_LOCALE['10749'] |$
                </li>
                <li id="delete">
                    $| LANG_LOCALE['10695'] |$
                </li>
            </ul>
        </div>
        <!-- Right click Div End -->
            <tr>
                <td valign="top" align="center">
                <div class="midWidth">
                    <script language="JavaScript">
                        mmSel("mainMenu5");
                    </script>
			<?lua if (statusSuccessMessage ~= returnCodes.NIL) then ?>
			<div class="msgSuccess">
                        <p>$| statusSuccessMessage or '' |$</p>
			</div>
		   	<?lua elseif (statusErrorMessage ~= returnCodes.NIL) then?>
			<div class="msgError">
                    <p>$| statusErrorMessage or '' |$</p>
            </div> 
            <?lua  end?>
            <div align="left">
                 <nav class="nav-bg">
                      <ul class="menu">
                          <li>
                              <a href="?page=firewallRules.html">$| LANG_LOCALE['30315'] |$</a>
                          </li>
                          <li>
                              <a href="?page=firewallRulesIpv6.html">$| LANG_LOCALE['11452'] |$</a>
                          </li>
                          <?lua if(UNIT_NAME ~= "DSR-250N" and UNIT_NAME ~= "DSR-250" and UNIT_NAME ~= "DSR-150N" and UNIT_NAME ~= "DSR-150") then ?>
                          <li class="current">
                              <a href="?page=bridgeFirewallRules.html">$| LANG_LOCALE['30316'] |$</a>
                          </li>
                          <?lua end ?>
                      </ul>
                 </nav>
            </div>
            <div class="FL2">
            	<p class="hint">
        			$| helpHintText |$
	            </p>
            </div>
            <h1>$| LANG_LOCALE['30293'] |$</h1>
            <div class="CLR">
            	<div class="demo_jui" id="tf1_bridgeFirewallRules">
                	<table cellpadding="0" cellspacing="0" border="0" class="display" id="recordsData">
                    	<thead>
                        	<tr>
                            	<th> $| LANG_LOCALE['13004'] |$ <br> &nbsp; </th>
                                <th> $| LANG_LOCALE['10747'] |$ <br> &nbsp; </th>
                                <th> $| LANG_LOCALE['12831'] |$ <br> &nbsp; </th>
                                <th> $| LANG_LOCALE['10056'] |$ <br> &nbsp; </th>
                                <th> $| LANG_LOCALE['13453'] |$ <br> $| LANG_LOCALE['14197'] |$ </th>
                                <th> $| LANG_LOCALE['13454'] |$ <br> $| LANG_LOCALE['14197'] |$ </th>
                                <th> $| LANG_LOCALE['13453'] |$ <br> $| LANG_LOCALE['14043'] |$ </th>
                                <th> $| LANG_LOCALE['13454'] |$ <br> $| LANG_LOCALE['14043'] |$ </th>
                            </tr>
                        </thead>
                        <?lua 
							for k, v in pairs (bridgeFirewallTbl) do
						?>
                        	<tr class="gradeA" id="bridgeFirewallRules$|v["_ROWID_"]|$" status="$| v["ruleStatus"] or '' |$">
                            	<td>$| v["ruleStatus"] or '' |$</td>
                                <td>$| v["Direction"] or '' |$</td>
								<?lua
                                    local len = #v["ServiceName"]
                                    local serviceName = ""
                                    if(len >32) then
                                    	serviceName = v["ServiceName"]
                                        v["ServiceName"] = string.sub(v["ServiceName"],1,32) .. "..."
                                    end
                                ?>
                                <td title="$| serviceName |$">$| v["ServiceName"] |$</td>
								<?lua
                                	local action = ""
                                    if( v["Action"] == "Block Always") then
					            		action = LANG_LOCALE['30471']
                                    elseif( v["Action"] == "Allow Always") then
                                        action = LANG_LOCALE['30486']
                                    end
                                ?>
                                <td>$| action |$</td>
								<?lua
                                	local SourceMAC = "&nbsp;"
                                	if (v["SourceMACAddressType"] == "0") then
                                    	SourceMAC = LANG_LOCALE['10226'] 
                                    elseif (v["SourceMACAddressType"] == "1") then  
                                    	SourceMAC = v["SourceMACAddressStart"]    
                                    elseif (v["SourceMACAddressType"] == "2") then  
                                        SourceMAC = v["SourceMACAddressStart"] .. "-\n" .. v["SourceMACAddressEnd"]  
                                    end  
                                    local DestMAC = "&nbsp;"
                                    if (v["DestinationMACAddressType"] == "0") then
                                    	DestMAC = LANG_LOCALE['10226']
                                    elseif (v["DestinationMACAddressType"] == "1") then  
                                    	DestMAC = v["DestinationMACAddressStart"]    
                                    elseif (v["DestinationMACAddressType"] == "2") then  
                                    	DestMAC = v["DestinationMACAddressStart"] .. "-\n" .. v["DestinationMACAddressEnd"]  
                                    end
                                    local SourceIP = "&nbsp;"
                                    if (v["SourceAddressType"] == "0") then
                                    	SourceIP = LANG_LOCALE['10226']
                                    elseif (v["SourceAddressType"] == "1") then  
                                    	SourceIP = v["SourceAddressStart"]    
                                    elseif (v["SourceAddressType"] == "2") then  
                                    	SourceIP = v["SourceAddressStart"] .. "-\n" .. v["SourceAddressEnd"]  
                                    end
                                    local DestIP = "&nbsp;"
                                    if (v["DestinationAddressType"] == "0") then
                                    	DestIP = LANG_LOCALE['10226']
                                    elseif (v["DestinationAddressType"] == "1") then  
                                    	DestIP = v["DestinationAddressStart"]    
                                    elseif (v["DestinationAddressType"] == "2") then  
                                    	DestIP = v["DestinationAddressStart"] .. "-\n" .. v["DestinationAddressEnd"]  
                                    end
                                ?>
                                <td>$| SourceIP |$</td>
                                <td>$| DestIP |$</td>
                                <td>$| SourceMAC |$</td>
                                <td>$| DestMAC |$</td>
                            </tr>
                            <?lua 
						        end 
                            ?>
                                    </table>
                                </div>
                            </div>
                            <div class="buttonsRow" id="tf1_btnShowModal">
                                <input type="button" class="btnSubmit" title="$| LANG_LOCALE['10132'] |$" value="$| LANG_LOCALE['10132'] |$" id="btSave" onclick="openForm('button.add.bridgeFirewallRules.bridgeFirewallRules',-1,'tf1_dialog','bridgeFirewallRules','bridgeFirewallRulesForm.html', 'tf1_bridgeFirewallRulesDailogContent','onloadBridgeFirewallRulesFn');">
                            </div>
                            <div class="break">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div></td>
            </tr>
            <tr>
                <td>
                <?lua web.includeMenu("footer.html")?></td>
            </tr>
        </table>
    	<script type="text/javascript" language="javascript" src="js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" language="javascript" src="js/mis.js"></script>
        <script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
        <script type="text/javascript" language="javascript" src="js/ipv4AddrValidations.js"></script>
        <script type="text/javascript" language="javascript" src="js/mgmt.js"></script>
        <script type="text/javascript" language="javascript" src="js/bridgeFirewallRules.js"></script>
        <script type="text/javascript" language="javascript" src="js/contextMenu.js"></script>
        <script type="text/javascript" charset="utf-8">

            $(document).ready(function() {
                
                $('#tf1_bridgeFirewallRules .gradeA').contextMenu('contextMenu', {
                    bindings : {
                        'editMenu' : function(t, e, rowId) {
                            openForm('button.edit.bridgeFirewallRules.bridgeFirewallRules',rowId,'tf1_dialog','bridgeFirewallRules','bridgeFirewallRulesForm.html', 'tf1_bridgeFirewallRulesDailogContent','onloadBridgeFirewallRulesFn');
                        },
                        'deleteMenu' : function(t, e, rowId) {
                            deleteRows('button.delete.bridgeFirewallRules.bridgeFirewallRules', 'tf1_frmBridgeFirewallRules', rowId, 'optionSelectAll', 'tf1_dialog', 'bridgeFirewallRules', 'bridgeFirewallRules');
                        },
                        'disableMenu' : function(t, e, rowId) {
                            changeRowStauts('disable', 'tf1_frmBridgeFirewallRules', rowId, 'tf1_dialog', 'bridgeFirewallRules', 'bridgeFirewallRules', 'bridgeFirewallRules.bridgeFirewallRules', 'optionSelectAll');
                        },
                        'enableMenu' : function(t, e, rowId) {
                            changeRowStauts('enable', 'tf1_frmBridgeFirewallRules', rowId, 'tf1_dialog', 'bridgeFirewallRules', 'bridgeFirewallRules', 'bridgeFirewallRules.bridgeFirewallRules', 'optionSelectAll');
                        }
                    },
                    onShowMenu: function(e,menu,rowId) {
			if ($("#"+rowId).attr("status") == "Enabled"){
				$('#enableMenu', menu).remove();
			} else {
				$('#disableMenu', menu).remove();
			}
			return menu;
		}
                });

                oTable = $('#recordsData').dataTable({
                    "bJQueryUI" : true,
                    "sPaginationType" : "full_numbers",
                    "columnDefs": [
                        { type: 'ip-address', targets: 4 },
                        { type: 'ip-address', targets: 5 }
                    ]
                });
                dataRightClick(true);
                $("#btnClose").live("click",function(e){
                    HideDialog('tf1_dialog', 'tf1_overlay');
                    e.preventDefault();
                   });

            });
        </script>
    </body>
</html>
<?lua end ?>
