<?lua
loginInfo = nil
require "teamf1lualib/openvpn"
require "teamf1lualib/errorMap"
local errorMap    = require ("com.teamf1.core.errorMap")


-- logout
if (ButtonType and ButtonType == "logout") then
     local result, errorStr = openvpn.logout(cgilua.cookies.get("TeamF1OmniSSLLogin"), SAPI.Request.servervariable("REMOTE_ADDR"))
--if success, delete cookie
if (result == 0) then
    util.appendDebugOut("SUCCESSFULLY LOGGED OUT!<br>")
    web.goToPage("OmniSSLPortalLogin", true, true)
end
-- if login button
elseif (ButtonType and ButtonType == "login") then
    local inputTable = web.cgiToLuaTable(cgi)
    --openvpn.currentUserLogout()
    -- authenticate and login
    local status,statusMsg,loginConf, SessionTimeout = openvpn.login(inputTable)
    if (status == 0) then
        util.appendDebugOut("VALID LOGIN!<br>")    
        util.appendDebugOut("NORMAL LOGIN!<br>")
            web.goToPage(NextPage, true, true)    
    elseif (status == 1) then 
        util.appendDebugOut("REPEAT LOGIN!<br>")
        statusMessage = statusMsg
        loginInfo = loginConf
        errorFlag = "OK"
        web.goToPage(OMNISSL_FORCED_LOGIN_PAGE, false, true)
    elseif (status == 2) then
        util.appendDebugOut("Authentication Failed, Server Unreachable <br>")
        statusMessage = db.getAttribute("stringsMap", "stringId", statusMsg, LANGUAGE) or statusMsg
        -- go back to login page
        web.goToPage("OmniSSLPortalLogin", true, true) 
    elseif (status == 3) then
        util.appendDebugOut("Openvpn server is Not enable <br>")
        statusMessage = errorMap.errorStringGet (statusMsg)
        web.goToPage("OmniSSLPortalLogin", true, true) 
    else
        util.appendDebugOut("INVALID LOGIN. TRY AGAIN!<br>")
        statusMessage = db.getAttribute("stringsMap", "stringId", statusMsg, LANGUAGE) or statusMsg
        -- go back to login page
        web.goToPage("OmniSSLPortalLogin", true, true)    
    end
else
	if (cgi["redirectStatusMessage"] ~= nil and cgi["redirectStatusMessage"] ~= '') then
  		statusMessage = cgi["redirectStatusMessage"]
	end
cgilua.header ("Content-Type","text/html; charset=UTF-8")
LANG_LOCALE = "50014,13242,11899,11617,14381,14382,20012,30238,14383,12144,12074"
LANG_LOCALE = db.getString (LANG_LOCALE)
?>
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Language" content="en-us">
		<title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
		<!--
		Copyright (c) 2015 TeamF1, Inc. (www.TeamF1.com)
		All rights reserved.
		-->
		<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
		<link rel="stylesheet" type="text/css" href="css/menu.css" />
		<script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
	</head>
	<body>
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td class="header" valign="top" align="center">
				<div align="center">
					<?lua web.includeMenu("OmniSSLheaderPlain.html")?></div></td>
			</tr>
			<tr>
				<td valign="top" align="center">
				<div class="midWidth2">
                                     <?lua if (statusMessage ~= nil and statusMessage ~= '') then ?>
				         <div class="blank">
                      	                 &nbsp;
                                         </div>
					 <div class="msgError">
		                  	 <p>$| statusMessage |$</p>
		                         </div>
					 <div class="blank">
                      	                 &nbsp;
                                         </div>
				     <?lua end ?>
					<div class="FL2">
						<p class="hint">
							$| LANG_LOCALE['50014'] |$
						</p>
					</div><h1>OmniSSL Login</h1>
					<div class="midArea">
						<div class="configLogin">
							<form method="post" action="platform.cgi" name="tf1_frmIndex" id="tf1_frmIndex">
								<input type="hidden" name="thispage" value="OmniSSLPortalLogin.html">
								<div class="break">
									&nbsp;
								</div>
								<div class="configRow">
									<label>$| LANG_LOCALE['13242'] |$</label>
									<input name="Users.UserName" type="text" id="tf1_userName" >
								</div>
								<div class="break">
									&nbsp;
								</div>
								<div class="configRow">
									<label>$| LANG_LOCALE['11899'] |$</label>
									<input name="Users.Password" type="password" id="tf1_password" >
								</div>
								<div class="break">
									&nbsp;
								</div>

								<div class="submitRow2">
									<input type="submit" name ="button.login.OpenvpnSession.omniSslPackage" class="btnSubmit" title="$| LANG_LOCALE['11617'] |$" value="$| LANG_LOCALE['11617'] |$" id="tf1_btnLogin" onclick="return loginValidate()" >
								</div>
								<input type="hidden" name="Login.userAgent" id="tf1_hdUserAgent">
								<input type="hidden" name="loggedInStatus" id="loggedInStatus" value="">
								<div class="break">
									&nbsp;
								</div>
							</form>
							<script language="javascript" type="text/javascript">
								if (document.getElementById('tf1_hdUserAgent'))
									document.getElementById('tf1_hdUserAgent').value = navigator.userAgent;
							</script>
						</div>
					</div>
				</div>
				<!-- 52737 starts -->
				<p class="supported"> <b>$| LANG_LOCALE['14381'] |$: </b>$| LANG_LOCALE['14382'] |$ 9+, $| LANG_LOCALE['20012'] |$ 20+, $| LANG_LOCALE['30238'] |$ 25+, $| LANG_LOCALE['14383'] |$ 5+ </p>
				<!-- 52737 ends -->

  			</td>
			</tr>
			<tr>
				<td>
				<?lua web.includeMenu("footer.html")?></td>
			</tr>
		</table>
		<script type="text/javascript" language="javascript" src="js/mis.js"></script>
		<script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
		<script type="text/javascript" charset="utf-8">
			function loginValidate() {
				var txtFieldIdArr = new Array();
				txtFieldIdArr[0] = "tf1_userName,"+LANG_LOCALE['12144'];
				txtFieldIdArr[1] = "tf1_password,"+LANG_LOCALE['12074'];

				if (txtFieldArrayCheck(txtFieldIdArr) == false)
					return false;

				return true;
			}

			function loginInit() {
				var usrObj = document.getElementById('tf1_userName');
				if (!usrObj)
					return;
				usrObj.focus();
			}


			$(document).ready(function() {
				loginInit();
			});
		</script>
	</body>
</html>
<?lua end ?>
