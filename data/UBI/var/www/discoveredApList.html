<?lua
require "teamf1lualib/discoveredAps_bl"
require "teamf1lualib/returnCodes"
require "teamf1lualib/util"
require "teamf1lualib/bl_manageAp"
require "teamf1lualib/errorMap"
require "teamf1lualib/wlan_returnCodes"

	PAGE_HELP = "wireless"
	PAGE_HELP_SECTION = "discoveredApList"

local discoveredAPs = require("com.teamf1.bl.wlan.discovredAps")
local guiManageAp = require("com.teamf1.bl.wlan.manageap")
local returnCodes = require("com.teamf1.core.returnCodes")
local errorMap    = require ("com.teamf1.core.errorMap")
local wlanReturnCodes  = require ("com.teamf1.core.wlan.wlanReturnCodes")

local errorCode, apProfileTbl

errorCode, apProfileTbl = guiManageAp.apProfileChannelsGet ()
if (errorCode ~= returnCodes.SUCCESS) then
    statusErrorMessage = errorMap.errorStringGet (errorCode)
end


if (ButtonType and (ButtonType == "manage" or ButtonType == "acknowledge")) then
     local configRow = web.cgiToLuaTable(cgi)
     local page = "discoveredApList"
     local removePrefix = page .. "."
     configRow = util.removePrefix (configRow, removePrefix)
     configRow["page"] = 2
     --local inputTable = web.cgiToLuaTable (cgi)
     --inputTable = util.removePrefix (inputTable, "discoveredAipList.")
     errorCode, PROMT_MESSAGE = guiManageAp.manageApAdd (configRow)
     if (errorCode ~= returnCodes.SUCCESS) then
         if (errorCode == wlanReturnCodes.AP_PROMT_MESSAGE_MANAGED) then
             MAC_ADDRESS = configRow.macAddress
             statusInfoMessage = errorMap.errorStringGet (errorCode)
         else
             statusErrorMessage = errorMap.errorStringGet (errorCode)
         end
     elseif(errorCode == returnCodes.SUCCESS)then
         statusSuccessMessage = errorMap.errorStringGet (errorCode)
     end
     web.goToPage(NextPage, true, true)
--[[elseif (ButtonType and ButtonType == "acknowledge") then
     local configRow = web.cgiToLuaTable(cgi)
     local page = "discoveredApList"
     local removePrefix = page .. "."
     configRow = util.removePrefix (configRow, removePrefix)
     configRow["page"] = 2
     --local inputTable = web.cgiToLuaTable (cgi)
     --inputTable = util.removePrefix (inputTable, "discoveredAipList.")
     local errorCode = guiManageAp.manageApAdd (configRow)
      if (errorCode ~= returnCodes.SUCCESS) then
       statusErrorMessage = errorMap.errorStringGet (tonumber(errorCode))
      elseif(errorCode == returnCodes.SUCCESS)then
       statusSuccessMessage = errorMap.errorStringGet (errorCode)
      end
     web.goToPage(NextPage, true, true)]]--
elseif(ButtonType and ButtonType == "delete") then
    local inputTable = web.cgiToLuaTable (cgi)
    --[[if(type(cgi["discoveredApList.checkbox"]) == "string") then
        local returnCode = discoveredAPs..discoveredAPsDelete(cgi["discoveredApList.checkbox"])
         if (returnCode ~= returnCodes.SUCCESS) then
             statusErrorMessage = errorMap.errorStringGet (tonumber(returnCode))
         elseif(returnCode == returnCodes.SUCCESS)then
                statusSuccessMessage = errorMap.errorStringGet (returnCode)
         end
         web.goToPage(NextPage, true, true)
    else]]--if(type(cgi["discoveredApList.checkbox"]) == "table") then
        local returnCode = discoveredAPs.discoveredAPsDelete()
         if (returnCode ~= returnCodes.SUCCESS) then
             statusErrorMessage = errorMap.errorStringGet (tonumber(returnCode))
         elseif(returnCode == returnCodes.SUCCESS)then
               statusSuccessMessage = errorMap.errorStringGet (returnCode)
         end
        web.goToPage(NextPage, true, true)
    --end
else
    local returnCode, discoveredApsTbl = discoveredAPs.discoveredAPsGet ()
    if (returnCode ~= returnCodes.SUCCESS) then
       statusErrorMessage = errorMap.errorStringGet (tonumber(returnCode))
    end
cgilua.header ("Content-Type","text/html; charset=UTF-8")
?>


<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Language" content="en-us">
        <title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
<!--
Copyright (c) 2012 - 2013 TeamF1, Inc. (www.TeamF1.com)
All rights reserved.
-->
        <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="css/style.css" />
        <link rel="stylesheet" type="text/css" href="css/buttons.css" />
        <link rel="stylesheet" type="text/css" href="css/menu.css" />
        <link rel="stylesheet" type="text/css" href="css/table.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.4.custom.css" />
        <script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
        <?lua web.includeMenu("metaInclude.html")?>
    </head>
    <body>
        <!-- Section for Pop up dialog starts -->
        <div id="tf1_overlay" class="configDialogMask"></div>                
        <form action="platform.cgi" method="post" name="tf1_frmDiscoveredApList" id="tf1_frmDiscoveredApList">        
            <input type="hidden" name="thispage" id="thispage" value="discoveredApList.html">            
            <div id="tf1_dialog" class="configDialog"></div>        
        </form>        
        <!-- Section for Pop up dialog ends -->    
        <!-- Right click Div Start -->
        <div class="contextMenu" id="contextMenu">
            <ul>
                <!--<li>
                    <input id="optionSelectAll" type="checkbox" onClick="setSelectAll (this.id, 'edit acknowledge details');"/>
                    &nbsp;Select All
                </li>-->
                <li id="edit">
                    Manage
                </li>
                <li id="acknowledge">
                    Acknowledge
                </li>
                <li id="details">
                    View Details
                </li>
                <li id="delete">
                    Delete All
                </li>
            </ul>
        </div>
        <!-- Right click Div End -->
        <table border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td class="header" valign="top" align="center">
                <?lua web.includeMenu("header.html")?></td>
            </tr>
            <tr>
                <td valign="top" align="center">
                <div class="midWidth">
                    <script language="JavaScript">
                        mmSel("mainMenu2");
                    </script>
                    <!-- Status message place holder... [ 1. for error use "msgError" 2. for information use "msgInfo" 3. for sucess use "msgSuccess" CSS classes ]
                    <div class="msgInfo">
                    <p>Status Message Place Holder.</p>
                    </div>
                    -->
                    <?lua if ( statusErrorMessage ~= returnCodes.NIL) then
                                          ?>
                                         <div class="msgError">
                                             <p>$| statusErrorMessage |$</p>
                                         </div>
                                         <?lua elseif(statusInfoMessage ~= returnCodes.NIL) then
                                         ?>
                                        <div class="msgInfo">
                                              <p>$| statusInfoMessage .. ":" .. MAC_ADDRESS |$</p>
                                        </div>
                                         <?lua elseif(statusSuccessMessage ~= returnCodes.NIL) then
                                         ?>
                                        <div class="msgSuccess">
                                              <p>$| statusSuccessMessage |$</p>
                                        </div>
                                        <?lua  end ?> 

                    <div class="FL2">
                        <p class="hint">
                        $| helpHintText |$
                        </p>
                    </div>
                    <h1>Discovered AP List</h1>
                    <div class="CLR">
                        <div class="demo_jui" id="tf1_discoveredApList">
                            <table cellpadding="0" cellspacing="0" border="0" class="display" id="recordsData">
                                <thead>
                                    <tr>
                                        <th> MAC Address </th>
                                        <th> IP Address </th>
                                        <th> Last Failure Type </th>
                                        <th> Age </th>
                                        <th> Radio </th>
                                        <th> Channel </th>
                                    </tr>
                                </thead>
                                <?lua
                                    for k, v in pairs (discoveredApsTbl) do
                                        local row = discoveredApsTbl[k]
                                        local channel, radio
                                        if (row.discoveredapsTYPE == 0) then
                                        if (row.discoveredapsHARDWARETYPE ==  9 or row.discoveredapsHARDWARETYPE == 11 or row.discoveredapsHARDWARETYPE == 8  or  row.discoveredapsHARDWARETYPE == 13)  then
                                            radio = row.discoveredapsRADIO5GHZ .. "," .. row.discoveredapsRADIO2_4GHZ
                                            channel = row.discoveredapsCHANNEL5GHZ .. "," .. row.discoveredapsCHANNEL2_4GHZ
                                            elseif(row.discoveredapsHARDWARETYPE == 10 or row.discoveredapsHARDWARETYPE ==12 ) then
                                                   radio =  row.discoveredapsRADIO2_4GHZ
                                                   channel = row.discoveredapsCHANNEL2_4GHZ
                                            else
                                                   radio = "N/A"
                                                   channel = "N/A"
                                            end
                                        elseif(row.discoveredapsTYPE == 2) then
                                            radio = row.discoveredapsRADIO5GHZ
                                            channel = row.discoveredapsCHANNEL5GHZ
                                        else
                                             radio = "N/A"
                                             channel = "N/A"
                                        end
                                          
                                ?>
                                <?lua
                                    if (channel == 0) then
                                       channel ="N/A"
                                    end
                                    if (row.discoveredapsIPADDRESS == '0.0.0.0') then
                                        row.discoveredapsIPADDRESS = "N/A"
                                    end

?>
                                <tr class="gradeA"
                                    id="discoveredApList$|row.discoveredapsMACADDRESS
                                    .. "-" .. row.discoveredapsTYPE |$" roguestatus="$| row.discoveredapsSTATUS |$">
                                    <?lua 
                                    local macClass = "highlight3"
                                    if (row.discoveredapsSTATUS == "Peer WS Managed") then
                                        macClass = "highlight4"
                                    elseif ((row.discoveredapsSTATUS == "Managed") or 
                                        (row.discoveredapsSTATUS == "Discovered") or
                                        (row.discoveredapsSTATUS == "Authenticated")) then 
                                        macClass = "highlight2"
                                    elseif ((row.discoveredapsSTATUS == "Failed") or
                                        (row.discoveredapsSTATUS == "Connection Failed") or
                                        (row.discoveredapsSTATUS == "AP Relink") or
                                        (row.discoveredapsSTATUS == "Local Authentication") or
                                        (row.discoveredapsSTATUS == "Radius Authentication") or
                                        (row.discoveredapsSTATUS == "Radius Challenged") or
                                        (row.discoveredapsSTATUS == "Invalid Radius Response") or
                                        (row.discoveredapsSTATUS == "No Database Entry") or
                                        (row.discoveredapsSTATUS == "Not Managed") or
                                        (row.discoveredapsSTATUS == "Invalid Profile ID") or
                                        (row.discoveredapsSTATUS == "Last") or
                                        (row.discoveredapsSTATUS == "Radius Unreachable")) then
                                        macClass = "highlight1"
                                    else
                                        macClass = "highlight3"
                                    end?>
                               <td class="spangradeA" id="discoveredApList$|row.discoveredapsMACADDRESS  .. "-" .. row.discoveredapsTYPE |$" roguestatus="$| row.discoveredapsSTATUS |$"><span class="$| macClass or 'highlight3'|$"  >$|row.discoveredapsMACADDRESS |$</span></td>
                                    <td> $| row.discoveredapsIPADDRESS |$ </td>
                                    <td> $| row.discoveredapsSTATUS |$ </td>
                                    <td> $| row.discoveredapsAGE |$ </td>
                                    <td> $| radio |$ </td>
                                    <td> $| channel |$ </td>
                                </tr>
                               <?lua end?>
                            </table>
                        </div>
                    </div>
                </div></td>
            </tr>
            <tr>
                <td>
                <?lua web.includeMenu("footer.html")?></td>
            </tr>
        </table>
        <script type="text/javascript" language="javascript" src="js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" language="javascript" src="js/mis.js"></script>
        <script type="text/javascript" language="javascript" src="js/mgmt.js"></script>
        <script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
        <script type="text/javascript" language="javascript" src="js/contextMenu.js"></script>
        <script type="text/javascript" language="javascript" src="js/discoveredApList.js"></script>
        <script type="text/javascript" charset="utf-8">
            function deleteRows( buttonPrefix, frmId, rowId, selBoxId, dialogId, rowPrefix, checkBoxPrefix) {
    $("#"+dialogId).html('');
    var re  = new RegExp(":",'g');
			 rowId = rowId.replace(re,"\\:");


    if ( $("#"+selBoxId+"Menu").is(':checked') ) {
        var childrenRows = $("#"+rowId).parent().children('tr');
        for (var i = 0; i < childrenRows.length; i++) {
            var thisElement = $(childrenRows[i]);
            thisRowId = thisElement.attr('id');
           
            thisRowId = thisRowId.replace(rowPrefix,"");
            $("#"+dialogId).append('<input type="hidden" name="'+checkBoxPrefix+'.checkbox" value="'+thisRowId+'">');
        }
    } else {
        rowId = rowId.replace(rowPrefix,"");
        $("#"+dialogId).append('<input type="hidden" name="'+checkBoxPrefix+'.checkbox" value="'+rowId+'">');
    }
   
    $("#"+dialogId).append('<input type="hidden" name="'+buttonPrefix+'" value="delete">');
   
    $("#"+frmId).submit();
}
            $(document).ready(function() {
                $('#tf1_discoveredApList .gradeA').contextMenu('contextMenu', {
                    bindings : {
                        'editMenu' : function(t, e, rowId) {
                            openForm('button.edit.discoveredApList.discoveredApList',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDailogContent','onloadDiscoveredApListFn');
                        },
                        'acknowledgeMenu' : function(t, e, rowId) {
                           openForm('button.acknowledge.discoveredApList.discoveredApList',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDailogContent','onloadDiscoveredApListFn'); 
                        },
                        'detailsMenu' : function(t, e, rowId) {
                            openPreviewForm('button.view.discoveredApList.discoveredApList','MAC',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDetailsDailogContent','');
                        },
                        'deleteMenu' : function(t, e, rowId) {
                            deleteRows('button.delete.discoveredApList.discoveredApList', 'tf1_frmDiscoveredApList', rowId, 'optionSelectAll', 'tf1_dialog', 'discoveredApList', 'discoveredApList');
                        }
                    },onShowMenu: function(e,menu,rowId) {
			 var re  = new RegExp(":",'g');
			 rowId = rowId.replace(re,"\\:");
			 
                        if ($("#"+rowId).attr("roguestatus") != "Rogue"){                            
                            $('#acknowledgeMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Managed"){                            
                            $('#editMenu', menu).remove();
                        }  
                        if ($("#"+rowId).attr("roguestatus") == "Discovered"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Authenticated"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Peer WS Managed"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Standalone"){                            
                            $('#editMenu', menu).remove();
                        }
                        return menu;
                    }

                });


		$('#tf1_discoveredApList .spangradeA').contextMenu('contextMenu', {
                    bindings : {
                        'editMenu' : function(t, e, rowId) {

			
                            openForm('button.edit.discoveredApList.discoveredApList',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDailogContent','onloadDiscoveredApListFn');
                        },
                        'acknowledgeMenu' : function(t, e, rowId) {
                           openForm('button.acknowledge.discoveredApList.discoveredApList',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDailogContent','onloadDiscoveredApListFn'); 
                        },
                        'detailsMenu' : function(t, e, rowId) {
                            openPreviewForm('button.view.discoveredApList.discoveredApList','MAC',rowId,'tf1_dialog','discoveredApList','discoveredApListForm.html', 'tf1_discoveredApListDetailsDailogContent','');
                        },
                        'deleteMenu' : function(t, e, rowId) {
                            deleteRows('button.delete.discoveredApList.discoveredApList', 'tf1_frmDiscoveredApList', rowId, 'optionSelectAll', 'tf1_dialog', 'discoveredApList', 'discoveredApList');
                        }
                    },onShowMenu: function(e,menu,rowId) {

			
			 var re  = new RegExp(":",'g');
			 rowId = rowId.replace(re,"\\:");

			 
			 
                        if ($("#"+rowId).attr("roguestatus") != "Rogue"){                            
                            $('#acknowledgeMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Managed"){                            
                            $('#editMenu', menu).remove();
                        }  
                        if ($("#"+rowId).attr("roguestatus") == "Discovered"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Authenticated"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Peer WS Managed"){                            
                            $('#editMenu', menu).remove();
                        }
                        if ($("#"+rowId).attr("roguestatus") == "Standalone"){                            
                            $('#editMenu', menu).remove();
                        }
                        return menu;
                    }

                });

                oTable = $('#recordsData').dataTable({
                    "bJQueryUI" : true,
                    "sPaginationType" : "full_numbers"
                });            

                dataRightClick(true);
                $("#btnClose").live("click",function(e){
                    HideDialog('tf1_dialog', 'tf1_overlay');
                    e.preventDefault();
                   });

            });
            function profileChange() {

		var selObj = document.getElementById("tf1_profile");
                var selValue = selObj.options[selObj.selectedIndex].value;
                var chan1Obj = document.getElementById("tf1_radio1Channel");
                var chan2Obj = document.getElementById("tf1_radio2Channel");
                chan1Obj.options.length = 0;
                chan2Obj.options.length = 0;

			<?lua
                 		if (apProfileTbl ~= nil) then
                	            for k, v in pairs (apProfileTbl) do
                		        local row = apProfileTbl[k]
                	?>
			
				if ( selValue == '$| row.profileId |$' ) {
                        <?lua
                                for l, m in pairs (row.radio1Channels) do 
                        ?>
                chan1Obj.options[chan1Obj.options.length] = new  Option('$| m.name |$',
                                                                            '$| m.value |$');
                        <?lua end 
                                for i, j in pairs (row.radio2Channels) do 
                        ?>                        
                chan2Obj.options[chan2Obj.options.length] = new Option('$|j.name |$',
                                                                           '$| j.value |$');
                        <?lua end ?>
				}
		        <?lua
                		end
                		end
                	?>	

				
			}
        </script>
    </body>
</html>
<?lua end ?>
