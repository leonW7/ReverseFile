<?lua 
require "teamf1lualib/changePassword_bl"
require "teamf1lualib/errorMap"
require "teamf1lualib/returnCodes"
require "teamf1lualib/portalInfo_bl"
local portalInfo = require ("com.teamf1.bl.portalInfo")
local cookiePortal = cgilua.cookies.get ("TeamF1PortalName")
local returnCode, isVPNEnabled, isPortFowrwardingEnabled = 
                                portalInfo.portalInfoGet (cookiePortal)
local portalChangePasswd = require ("com.teamf1.bl.changePwd")
local returnCodes = require ("com.teamf1.core.returnCodes")
local errorMap    = require ("com.teamf1.core.errorMap")
if (ButtonType and ButtonType == "config") then
    local inputTable = web.cgiToLuaTable(cgi)
    inputTable["changePassword.ipAddr"] = SAPI.Request.servervariable("REMOTE_ADDR")
    inputTable["changePassword.cookie"] = cgilua.cookies.get("TeamF1Login")
    local returnCode = portalChangePasswd.changePasswordSet (inputTable)
    if (returnCode == returnCodes.SUCCESS) then
        statusSuccessMessage = errorMap.errorStringGet (returnCode)
    else 
        statusErrorMessage = errorMap.errorStringGet (returnCode)
        NextPage = "changePassword"
    end
    web.goToPage(NextPage, true, true)
else
	
?>
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Language" content="en-us">
		<title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
		<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
		<link rel="stylesheet" type="text/css" href="css/menu.css" />
		<script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
		<script type="text/javascript" language="javascript" src="js/mis.js"></script>
		<script language="javascript">
			function validatePassword() {
				
				var oldPassword = $.trim($("#tf1_oldPassword").val());
				var newPassword = $.trim($("#tf1_newPassword").val());
				var retypePassword = $.trim($("#tf1_reTypePassword").val());
				
				if ( oldPassword == "" || newPassword == "" || retypePassword == "" ) {
					alert("Please enter all fields");
					return false;
				}

				if ( newPassword != retypePassword) {
					alert("New password and Confirm password do not match");
					return false;
				}
				return true;
			}
        </script>
        <?lua web.includeMenu("metaInclude.html")?>
	</head>
	<body onLoad="onloadCall ();">
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td class="header" valign="top" align="center"><!--webbot bot="Include" U-Include="header.html" TAG="BODY" startspan -->
		<div align="center">
			<div class="midWidth">
				<div class="logo FL">
					Unified Services Router - $| UNIT_NAME |$
				</div>
				 <div class="FR headerRight">
					<table border="0" cellpadding="0" cellspacing="0">
						 
						<tr>
                                                        <td valign="top">&nbsp;</td>
                                                        <td rowspan="2" valign="top">
							<a class="btnLogout" href="?page=portalLogin.html&portal=$| cookiePortal |$">
							<div>
								<div>
									<icon>
										Logout
									</icon>
								</div>
							</div> </a></td>
						</tr>
						 
					</table>
				</div>
				  <div class="midWidth menuBg">
					<div>
						<div>
							<div align="center">
								<table border="0" cellpadding="0" cellspacing="0">
									<tr>
										<td>
										<ul id="menu">
											<div class="menuDiv">
												&nbsp;
											</div>
											<li id="mainMenu1">
												<a href="?page=portalInformation.html">Portal Information</a>
											</li>
											<div class="menuDiv">
												&nbsp;
											</div>
                                                                                        <?lua if(isVPNEnabled == "1") then?>
											<li id="mainMenu2">
							<a href="?page=vpnTunnels.html">VPN Tunnel</a>
											</li>
											<div class="menuDiv">
												&nbsp;
											</div>
                                                                                        <?lua end?>
                                                                                        <?lua if(isPortFowrwardingEnabled == "1") then?>
											<li id="mainMenu3">
												<a href="?page=portForwarding.html">Port Forwarding</a>
											</li>
											<div class="menuDiv">
												&nbsp;
											</div>
                                                                                        <?lua end?>
											<li id="mainMenu4">
												<a href="?page=changePassword.html">Change Password</a>
											</li>
											<div class="menuDiv">
												&nbsp;
											</div>
										</ul></td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>
				 
			</div>
		</div>
  </td>
			</tr>
			<tr>
				<td valign="top" align="center">
				<div class="midWidth">
                   <?lua if(statusErrorMessage ~= returnCodes.NIL) then
                    ?>
                    <div class="msgError">
                    <p>$| statusErrorMessage |$</p>
                    </div>
                    <?lua elseif (statusSuccessMessage ~= returnCodes.NIL) then?>
                    <div class="msgSuccess">
                    <p>$| statusSuccessMessage |$</p>
                    </div>
                    <?lua end ?>
					<div class="FL2">
						<p class="hint">
							 
						</p>
					</div>
					<h1>CHANGE PASSWORD	</h1>
					<div class="midArea">
						<div align="left">
							<form name action="platform.cgi" method="post">
                                                      <input type="hidden" name="thispage" value="changePassword.html">
								<h2>Password Configuration</h2>
                                <div class="break">&nbsp;</div>
                                <div class="configRow">
									<label>Old Password</label>
					 <input type="password" name="changePassword.oldPassword" id="tf1_oldPassword" value="" >
								</div>
								<div class="break">&nbsp;</div>
								<div class="configRow">
									<label>New Password</label>
						                <input type="password" name="changePassword.newPassword"  id="tf1_newPassword" value="">
								</div>
								<div class="break">&nbsp;</div>
                                <div class="configRow">
									<label>Retype New Password</label>
							<input type="password" name="changePassword.reTypePassword"  id="tf1_reTypePassword" value="">	 
								</div>
								<div class="break">&nbsp;</div>
								<div class="submitRow">
		<input type="submit" class="btnSubmit" title="Save" value="Save" id="btSave" name= "button.config.portalLogin" onclick="return validatePassword()" >
				<input type="reset" class="btnReset" title="Cancel" value="Cancel" id="btSave">
								</div>
								<div class="break">&nbsp;</div>                                 
							</form>
						</div>
					</div>
				</div></td>
			</tr>
			<tr>
				<td><!--webbot bot="Include" U-Include="footer.html" TAG="BODY" startspan -->
		<div class="footer">
			Copyright &#169; 2017 D-Link Corporation.
		</div>
	<!--webbot bot="Include" i-checksum="35774" endspan --></td>
			</tr>
		</table>
               <script language="JavaScript">
                        mmSel("mainMenu4");
                    </script>
	</body>
</html>
<?lua end?>
