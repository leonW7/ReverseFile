<?lua 
require "teamf1lualib/loginProfiles_bl"
require "teamf1lualib/errorMap"


	PAGE_HELP = "security"
        if(UNIT_NAME == "DSR-150" or UNIT_NAME == "DSR-150N" or UNIT_NAME == "DSR-250" or UNIT_NAME == "DSR-250N") then
           PAGE_HELP_SECTION = "loginProfiles_econa"                     
       	else                                            
          PAGE_HELP_SECTION = "loginProfiles"                
        end           
	

local errorMap         = require ("com.teamf1.core.errorMap")
local gui_loginProfile = require("com.teamf1.bl.captiveportal.loginprofiles")

if (ButtonType and ButtonType == "delete") then
    local errorFlag
    local inputTable = web.cgiToLuaTable(cgi)
    if(type(cgi["loginProfiles.checkbox"]) == "string") then
        inputTable["profileTable.cookie"] = cgi["loginProfiles.checkbox"]
        errorFlag, cookie = gui_loginProfile.profileDelete (inputTable)
        if (errorFlag == 0) then
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)
    elseif (type(cgi["loginProfiles.checkbox"]) == "table") then
        errorFlag, cookie = gui_loginProfile.profileDeleteAll ()
        if (errorFlag == 0) then
            statusSuccessMessage = errorMap.errorStringGet (errorFlag)
        else
            statusErrorMessage = errorMap.errorStringGet (errorFlag)
        end
        web.goToPage(NextPage, true, true)
    end
    
elseif (ButtonType and ButtonType == "add") then
    local inputTable = web.cgiToLuaTable(cgi)
    inputTable["profileTable.cookie"] = cgi["configRowId"]
    errorFlag, cookie = gui_loginProfile.profileCreate (inputTable)
    if (errorFlag == 0) then
        statusSuccessMessage = errorMap.errorStringGet (errorFlag)
    else
        statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
    web.goToPage(NextPage, true, true)

elseif (ButtonType and ButtonType == "edit") then
    local inputTable = web.cgiToLuaTable(cgi)
    inputTable["profileTable.cookie"] = cgi["configRowId"]
    errorFlag, cookie = gui_loginProfile.profileSet (inputTable)
    if (errorFlag == 0) then
        statusSuccessMessage = errorMap.errorStringGet (errorFlag)
    else
        statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
    web.goToPage(NextPage, true, true)
elseif (ButtonType and ButtonType == "fileuploadBg") then
    local inputTable = web.cgiToLuaTable(cgi)
    inputTable["imageIndex"] = cgi["imageIndex"]
    errorFlag, filename = gui_loginProfile.backgroundImageUpload(inputTable)


    if (errorFlag ~= 0) then
        filename = errorMap.errorStringGet (errorFlag)
    end
    cgilua.header ("Content-Type","text/html; charset=UTF-8")

?>
$|filename or 'Error:Filed to Upload'|$
<?lua
elseif (ButtonType and ButtonType == "fileuploadHd") then
    local inputTable = web.cgiToLuaTable(cgi)
    inputTable["imageIndex"] = cgi["imageIndex"]
    errorFlag, filename = gui_loginProfile.headerImageUpload(inputTable)
  
    if (errorFlag ~= 0) then
        filename = errorMap.errorStringGet (errorFlag)
    end
    
    cgilua.header ("Content-Type","text/html; charset=UTF-8")

?>
$|filename or 'Error: Failed to Upload'|$
<?lua
else
    local returnCode, loginTable = gui_loginProfile.profilesGetAll ()
    if (returnCode ~= 0) then
        errorString = "There is some issue"
    end
cgilua.header ("Content-Type","text/html; charset=UTF-8")

LANG_LOCALE = "11624,12560,10426,13004,10139,13610,13679,13680,11062,11621,10346,11159,10543,11894,10683,11893,13670,13667,13668,13669,10648,13677,11713,13678,11106,11104,11103,11105,12758,11028,13666,11026,11027,10471,10950,13361,11618,11626,11024,11025,13672,11705,13671,10453,13676,13675,13674,13673,10100,30287,12348,12232,12332,12280,12274,12377,12322,12403,12273,12374,12375,12232,30430,30431,30432,30309,12438,12450,11236,13611,13194,12443,30524,30577,12795,10862,13610,10695,14429,14430,14431,14432,14433,14434,14435"
       ?>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Language" content="en-us">
        <title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
<!--
Copyright (c) 2012 - 2013 TeamF1, Inc. (www.TeamF1.com)
All rights reserved.
-->
        <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="css/style.css" />
        <link rel="stylesheet" type="text/css" href="css/buttons.css" />
        <link rel="stylesheet" type="text/css" href="css/menu.css" />
        <link rel="stylesheet" type="text/css" href="css/table.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.4.custom.css" />
        <script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
        <?lua web.includeMenu("metaInclude.html")?>
    </head>
    <body>
    <!-- Section for Pop up dialog starts -->
    <div id="tf1_overlay" class="configDialogMask"></div>                
    <iframe id="uploader_iframe" name="uploader_iframe" style="display: none;"></iframe>
        <form  action="platform.cgi" method="post" enctype="multipart/form-data" name="tf1_frmLoginProfilesForm"
            id="tf1_frmLoginProfilesForm">    
            <input type="hidden" name="thispage" id="thispage" value="loginProfiles.html">            
            <div id="tf1_dialog" class="configDialog"></div>        
        </form>
        <!-- Section for Pop up dialog ends -->
        <table border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td class="header" valign="top" align="center">
                <?lua web.includeMenu("header.html")?></td>
            </tr>
        <!-- Right click Div Start -->
        <div class="contextMenu" id="contextMenu">
            <ul>
                <li>
                    <input id="optionSelectAll" type="checkbox" onClick="setSelectAll (this.id, 'edit details');"/>
                    &nbsp;$| LANG_LOCALE['12795'] |$
                </li>
                <li id="edit">
                    $| LANG_LOCALE['10862'] |$
                </li>
                <li id="details">
                    $| LANG_LOCALE['13610'] |$
                </li>
                <li id="delete">
                    $| LANG_LOCALE['10695'] |$
                </li>

            </ul>
        </div>
        <!-- Right click Div End -->
            <tr>
                <td valign="top" align="center">
                <div class="midWidth">
                    <script language="JavaScript">
                        mmSel("mainMenu5");
                    </script>
                    <!-- Status message place holder... [ 1. for error use "msgError" 2. for information use "msgInfo" 3. for sucess use "msgSuccess" CSS classes ]
                    <div class="msgInfo">
                    <p>Status Message Place Holder.</p>
                    </div>
                    -->
                    <?lua 
                    if (statusErrorMessage ~= nil) then
                    ?>    
                    <div class="msgError">
                    <p>$| statusErrorMessage |$</p>
                </div>
                <?lua elseif (statusSuccessMessage ~= nil) then
                ?>
                <div class="msgSuccess">
                    <p>$| statusSuccessMessage |$</p>
                </div>
                    <?lua end ?>

                    <!--div align="left">
                        <nav class="nav-bg">
                            <ul class="menu">
                                <li  class="current">
                                    <a href="?page=loginProfiles.html">Login Profiles</a>
                                </li>
                                <li>
                                    <a href="?page=loginProfilesSla.html">SLA</a>
                                </li>
                            </ul>
                        </nav>
                    </div-->

                    <div class="FL2">
                        <p class="hint">
                        $| helpHintText |$                        </p>
                    </div>
                    <h1>$| LANG_LOCALE['11624'] |$</h1>
                    <div class="CLR">
                        <div class="demo_jui" id="tf1_loginProfiles">
                            <table cellpadding="0" cellspacing="0" border="0" class="display" id="recordsData">
                                <thead>
                                        
                                    <tr>
                                        <th> $| LANG_LOCALE['12560'] |$ </th>
                                        <th> $| LANG_LOCALE['10426'] |$ </th>
                                        <th> $| LANG_LOCALE['13004'] |$ </th>
                                    </tr>
                                </thead>
                              <?lua 
                            local i = 0
                            for k, v in pairs (loginTable) do
                                i=i+1
                                local row = loginTable[k]

                                if (row["CaptivePortalPageDetails.profileStatus"] == "Not In Use") then
                                    row["CaptivePortalPageDetails.profileStatus"] = LANG_LOCALE['30577']
                                end

                            ?>

                                <tr profile-name="$|row["CaptivePortalPageDetails.configurationName"] or ''|$" class="gradeA" id="loginProfiles$| row["CaptivePortalPageDetails._ROWID_"] |$">
                                <td>$|row["CaptivePortalPageDetails.configurationName"] or ''|$</td>
                                <td>$|row["CaptivePortalPageDetails.title"] or ''|$</td>
                                <td>$|row["CaptivePortalPageDetails.profileStatus"]
                                    or 'None'|$</td>
                                </tr>
                              <?lua 
                                end 
                                ?>
                            </table>
                        </div>
                    </div>
                    <div class="buttonsRow" id="tf1_btnShowModal">
                        <input type="button"  class="btnSubmit" title="$| LANG_LOCALE['10139'] |$" value="$| LANG_LOCALE['10139'] |$" id="btSave" onclick="openForm('button.add.loginProfiles.loginProfiles',-1,'tf1_dialog','loginProfiles','loginProfilesForm.html', 'tf1_loginProfilesDailogContent','onloadCallloginProfilesFn');">
                    </div>
                </div></td>
            </tr>
            <tr>
                <td>
                <?lua web.includeMenu("footer.html")?></td>
            </tr>
        </table>
        <script type="text/javascript" language="javascript" src="js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" language="javascript" src="js/mis.js"></script>
        <script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
        <script type="text/javascript" language="javascript" src="js/mgmt.js"></script>
        <script type="text/javascript" language="javascript" src="js/contextMenu.js"></script>
        <script type="text/javascript" language="javascript" src="js/loginProfiles.js"></script>
	<script>
		 $(document).ready(function() { 
			
			$(".fileUploadBg").live("click",function(event){					
				
				event.preventDefault();
				$(".upFile").html('');
				

			var bgFileUploadHtml ='<div class="configRow" id="tf1_fileUploadBg_div" style="display:none"><label>$| LANG_LOCALE['13611'] |$ <span id="tf1_uploadFileIndex"></span></label><input name="file.upload" id="tf1_fileUploadBg_file" size="30" type="file" /></div><div class="break" id="break_fileUploadBg_div" style="display:none">&nbsp;</div><div class="submitRow"><input type="button" id="tf1_fileUploadBg" value="$| LANG_LOCALE['13194'] |$" class="btnSubmit"></div><div class="break" id="break_fileUploadBg_div">&nbsp;</div>';
				 $("#tf1_uploadBg_div").html(bgFileUploadHtml);
				 $("#tf1_uploadFileIndex").html($(this).attr("upload-index"));
				 $("#tf1_fileUploadBg_div").show();
				 $("#break_fileUploadBg_div").show();
				 
                               
			});

		$(".fileUploadHd").live("click",function(event){					
				
				event.preventDefault();
				$(".upFile").html('');
				

			var hdFileUploadHtml ='<div class="configRow" id="tf1_fileUploadHd_div" style="display:none"><label>$| LANG_LOCALE['30524'] |$ <span id="tf1_uploadFileIndexHd"></span></label><input name="file.upload" id="tf1_fileUploadHd_file" size="30" type="file" /></div><div class="break" id="break_fileUploadHd_div" style="display:none">&nbsp;</div><div class="submitRow"><input type="button" id="tf1_fileUploadHd" value="$| LANG_LOCALE['13194'] |$" class="btnSubmit"></div><div class="break" id="break_fileUploadHd_div">&nbsp;</div>';
	                   
				 $("#tf1_uploadHd_div").html(hdFileUploadHtml);
				$("#tf1_uploadFileIndexHd").html($(this).attr("upload-index"));
				 $("#tf1_fileUploadHd_div").show();
				 $("#break_fileUploadHd_div").show();
				 
                               
             });
               $("#tf1_fileUploadBg").live("click",function() {

	var fileName = $("#tf1_fileUploadBg_file").val();

	 if((/\.(gif|jpg|jpeg|png)$/i).test(fileName) == false) {
		alert(LANG_LOCALE['12443']);
		return false;
	}
	
	var bgIndex = $("#tf1_uploadFileIndex").html();

	var fileFields = '<input type="hidden" name="button.fileuploadBg.loginProfiles" id="tf1_buttonupload" value="backGroundImage" class="delete-filefield"><input type="hidden" name="imageIndex" id="tf1_imageIndex" value="'+bgIndex+'" class="delete-filefield">';
	
	$("#tf1_frmLoginProfilesForm").append(fileFields);
	$("#tf1_frmLoginProfilesForm").attr("target","uploader_iframe");
        $("#tf1_frmLoginProfilesForm").submit(); 
         // Submits the form on change event,
             $("#uploader_iframe").unbind().load(function() {
		$(".delete-filefield").remove();
		$("#tf1_frmLoginProfilesForm").removeAttr("target");
             		// This block of code will execute when the response is sent from the server.
                	responseText = $(this).contents().text();
	
			
			if (responseText.search("Error:") != -1)
			{	
				alert(responseText);
				
			} else {
			  	$(".upFile").html('');
				$(".divBgImage").each(function(index){
					
					if ($(this).attr("page-bg-id") == bgIndex) {
					  
						$(this).html('<img style="width:45px; height:45px" src="images/capPort/'+responseText+'?'+(new Date).getTime()+'">');
						$(this).attr("image","true");
					}
				});

				$(".fileUploadBg").each(function(index){
					
					if ($(this).attr("upload-index") == bgIndex) {
					  
						$(this).html('Change');
					}
				});
			}
			
                 });
  
  });

$("#tf1_fileUploadHd").live("click",function() {

	var fileName = $("#tf1_fileUploadHd_file").val();

	 if((/\.(gif|jpg|jpeg|png)$/i).test(fileName) == false) {
		alert(LANG_LOCALE['12443']);
		return false;
	}
	
	var hdIndex = $("#tf1_uploadFileIndexHd").html();

	var fileFields = '<input type="hidden" name="button.fileuploadHd.loginProfiles" id="tf1_buttonupload" value="headerImage" class="delete-filefield"><input type="hidden" name="imageIndex" id="tf1_imageIndex" value="'+hdIndex+'" class="delete-filefield">';
	
	$("#tf1_frmLoginProfilesForm").append(fileFields);
	$("#tf1_frmLoginProfilesForm").attr("target","uploader_iframe");
        $("#tf1_frmLoginProfilesForm").submit(); 
         // Submits the form on change event,
             $("#uploader_iframe").unbind().load(function() {
		$(".delete-filefield").remove();
		$("#tf1_frmLoginProfilesForm").removeAttr("target");
             		// This block of code will execute when the response is sent from the server.
                	responseText = $(this).contents().text();
	
			
			if (responseText.search("Error:") != -1)
			{	
				alert(responseText);
				
			} else {
			  	$(".upFile").html('');
				$(".divHdImage").each(function(index){
					
					if ($(this).attr("header-bg-id") == hdIndex) {
					  
						$(this).html('<img style="width:45px; height:45px" src="images/capPort/'+responseText+'">');
						$(this).attr("image","true");
					}
				});

				$(".fileUploadHd").each(function(index){
					
					if ($(this).attr("upload-index") == hdIndex) {
					  
						$(this).html('Change');
					}
				});
			}
			
                 });
  
  });
			
		});
	</script>
    </body>
</html>
<?lua end ?>
