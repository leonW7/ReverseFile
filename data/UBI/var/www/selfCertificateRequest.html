<?lua 
require "teamf1lualib/selfCertificateRequest_bl"
require "teamf1lualib/errorMap"
require "teamf1lualib/returnCodes"

	PAGE_HELP = "vpn"
	PAGE_HELP_SECTION = "selfCertificateRequest"

local selfCertReq = require ("com.teamf1.bl.certificates.selfCertRequest")
local returnCodes = require ("com.teamf1.core.returnCodes")
local errorMap    = require ("com.teamf1.core.errorMap")

if(ButtonType and ButtonType == "config") then
    local inputTable = web.cgiToLuaTable (cgi)
    if (RowId == "-1") then 
        local returnCode, cookie =
            selfCertReq.selfCertReqCreate(inputTable)
        if (returnCode == returnCodes.SUCCESS) then
            statusSuccessMessage = errorMap.errorStringGet (returnCode)
        else 
            statusErrorMessage = errorMap.errorStringGet (returnCode)
	end
        web.goToPage(NextPage, true, true)
    end
elseif(ButtonType and ButtonType == "delete") then
    local inputTable = web.cgiToLuaTable (cgi)
    if(type(cgi["selfCertificateRequest.checkbox"]) == "string") then
        inputTable["selfCertificateRequest.cookie"] = 
                cgi["selfCertificateRequest.checkbox"]
        local returnCode, cookie = 
             selfCertReq.selfCertReqDelete(inputTable)
        if (returnCode == returnCodes.SUCCESS) then
            statusSuccessMessage = errorMap.errorStringGet (returnCode)
        else 
            statusErrorMessage = errorMap.errorStringGet (returnCode)
	end
            web.goToPage(NextPage, true, true)
    elseif(type(cgi["selfCertificateRequest.checkbox"]) == "table") then
        local returnCode = selfCertReq.selfCertReqDeleteAll()
        if (returnCode == returnCodes.SUCCESS) then
            statusSuccessMessage = errorMap.errorStringGet (returnCode)
        else 
            statusErrorMessage = errorMap.errorStringGet (returnCode)
	end
        web.goToPage(NextPage, true, true)
    end
else
   local returnCode, configRow = selfCertReq.selfCertReqGetAll ()
   if(returnCode ~= returnCodes.SUCCESS) then
       statusErrorMessage = errorMap.errorStringGet (returnCode)
   end
   cgilua.header ("Content-Type", "text/html; charset=UTF-8")

   LANG_LOCALE =
   "13999,13151,10083,12810,12811,11748,11776,11065,13015,11102,11701,14106,12861,10276,11129,11419,11387,10805,10866,14113,13042,11102,14112,14111,14110,12064,12132,11251,11256,12795,10695,13999,13004"
?>
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Language" content="en-us">
		<title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
<!--
Copyright (c) 2012 - 2013 TeamF1, Inc. (www.TeamF1.com)
All rights reserved.
-->
		<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
		<link rel="stylesheet" type="text/css" href="css/menu.css" />
		<link rel="stylesheet" type="text/css" href="css/table.css" />
		<link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.4.custom.css" />
        <script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
        <?lua web.includeMenu("metaInclude.html")?>
	</head>
	<body>
	<!-- Section for Pop up dialog starts -->
		<div id="tf1_overlay" class="configDialogMask"></div>				
		<form name action="platform.cgi" method="post" enctype="multipart/form-data" name="selfCertificateRequest" id="tf1_frmSelfCertificateRequest">	
			<input type="hidden" name="thispage" id="thispage" value="selfCertificateRequest.html">
                        <input type="hidden" name="selfCertificateRequest.dbUpdateFlag" value="0">
			<input type="hidden" name="selfCertificateRequest.requestStatus" value="0">
			<div id="tf1_dialog" class="configDialog"></div>		
		</form>
        <!-- Section for Pop up dialog ends -->
		<table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td class="header" valign="top" align="center">
				<?lua web.includeMenu("header.html")?></td>
			</tr>
        <!-- Right click Div Start -->
		<div class="contextMenu" id="contextMenu">
			<ul>
				<li>
				<input id="optionSelectAll" type="checkbox" onClick="setSelectAll (this.id, 'details');"/>
					&nbsp;$| LANG_LOCALE['12795'] |$ 
				</li>
				<li id="delete">
					$| LANG_LOCALE['10695'] |$
				</li>
                                <li id="details">
					$| LANG_LOCALE['13999'] |$
				</li>

			</ul>
		</div>
		<!-- Right click Div End -->            
            <tr>
				<td valign="top" align="center">
				<div class="midWidth">
					<script language="JavaScript">
						mmSel("mainMenu4");
					</script>
					<!-- Status message place holder... [ 1. for error use "msgError" 2. for information use "msgInfo" 3. for sucess use "msgSuccess" CSS classes ]
					-->
                                        <?lua if(statusErrorMessage ~= returnCodes.NIL) then?>
                                          <div class="msgError">
                                          <p>$| statusErrorMessage |$</p>
                                           </div>
                                          <?lua elseif (statusSuccessMessage ~= returnCodes.NIL) then?>
                                         <div class="msgSuccess">
                                         <p>$| statusSuccessMessage |$</p>
                                          </div>
                                        <?lua end ?>
					<div align="left">
						<nav class="nav-bg">
							<ul class="menu">
								<li>
									<a href="?page=trustedCertificates.html">$| LANG_LOCALE['13151'] |$</a>
								</li>
								<li>
									<a href="?page=activeSelfCertificates.html">$| LANG_LOCALE['10083'] |$</a>
								</li>
								<li class="current">
                                    <a href="?page=selfCertificateRequest.html">$| LANG_LOCALE['12810'] |$</a>
                                </li>
							</ul>
						</nav>
					</div>
					<div class="FL2">
						<p class="hint">
							 $| helpHintText |$
						</p>
					</div>
					<h1>$| LANG_LOCALE['12811'] |$</h1>
					<div class="CLR">
						<div class="demo_jui" id="tf1_selfCertificates">
							<table cellpadding="0" cellspacing="0" border="0" class="display" id="recordsData">
								<thead>
									<tr>
										<th>$| LANG_LOCALE['11748'] |$</th>
										<th>$| LANG_LOCALE['13004'] |$</th>
									</tr>
                                </thead>                          
                                                                <?lua
                                                                -- Store the count of the available certificates
                                                                 for k,v in pairs(configRow) do
                                                                     local outputTbl = configRow[k]
                                                                     local rowId = outputTbl["_ROWID_"]
                                                                     local name = outputTbl["requestName"]
                                                                     local status = outputTbl["requestStatus"]
                                                                     if ((status == "1") or (status == "2"))then
                                                                         statusVal = "Active Self Certificate Uploaded"
                                                                     else
                                                                         statusVal = "Active Self Certificate Not Uploaded"
                                                                     end
                                                                ?>    
								<tr class="gradeA" id="selfCertificateRequest$| rowId |$">
									<td> $| name |$ </td>
									<td> $| statusVal |$ </td>
                                                                </tr>
                                                                <?lua end?>
							</table>
						</div>
					</div>
					<div class="buttonsRow" id="tf1_btnShowModal">
						<input type="button" class="btnSubmit" title="$| LANG_LOCALE['11776'] |$" value="$| LANG_LOCALE['11776'] |$" id="btSave" name="button.add.selfCertificateRequest.selfCertificateRequest.-1" onclick="openForm('button.add.selfCertificateRequest.selfCertificateRequest',-1,'tf1_dialog','selfCertificateRequest','selfCertificateRequestForm.html', 'tf1_selfCertificateRequestDailogContent','');">
					</div>
				</div></td>
			</tr>
			<tr>
				<td>
				<?lua web.includeMenu("footer.html")?></td>
			</tr>
		</table>
		<script type="text/javascript" language="javascript" src="js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" language="javascript" src="js/mis.js"></script>
		<script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
		<script type="text/javascript" language="javascript" src="js/ipv4AddrValidations.js"></script>
		<script type="text/javascript" language="javascript" src="js/mgmt.js"></script>
		<script type="text/javascript" language="javascript" src="js/contextMenu.js"></script>
		<script type="text/javascript" language="javascript" src="js/selfCertificateRequest.js"></script>
		<script type="text/javascript" charset="utf-8">
			$(document).ready(function() {
				$('#tf1_selfCertificates .gradeA').contextMenu('contextMenu', {
				bindings : {
				'deleteMenu' : function(t, e, rowId) {
					deleteRows('button.delete.selfCertificateRequest.selfCertificateRequest', 'tf1_frmSelfCertificateRequest', rowId, 'optionSelectAll', 'tf1_dialog', 'selfCertificateRequest', 'selfCertificateRequest');
				},
                               'detailsMenu' : function(t, e, rowId) {
                                         openForm('button.view.selfCertificateRequest.selfCertificateRequest',rowId,'tf1_dialog','selfCertificateRequest','selfCertificateRequestForm.html', 'tf1_selfCertificateViewDailogContent','');
								}

			}
			});
				oTable = $('#recordsData').dataTable({
					"bJQueryUI" : true,
					"sPaginationType" : "full_numbers"
				});
				dataRightClick(true);
				$("#btnClose").live("click",function(e){
					HideDialog('tf1_dialog', 'tf1_overlay');
					e.preventDefault();
			   	});
			});
		</script>
	</body>
</html>
<?lua end?>
