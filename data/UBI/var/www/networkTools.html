<?lua 
require "teamf1lualib/bl_networkTools"
require "teamf1lualib/errorMap"
require "teamf1lualib/returnCodes"
require "teamf1lualib/ipv6_mode_bl"
require "teamf1lualib/validations"
require "validationsLuaLib"

	PAGE_HELP = "maintenance"
	PAGE_HELP_SECTION = "networkTools"

local network = require("com.teamf1.bl.diagnostics.network")
local returnCodes = require ("com.teamf1.core.returnCodes")
local errorMap = require("com.teamf1.core.errorMap")
local validations = require("com.teamf1.core.validations")

if (ButtonType and ButtonType == "ping") then
    local inputTable = web.cgiToLuaTable(cgi)
    local ipToPing = inputTable["networkTools.IpAddress"]
     local ip6AddrCheck = validationsLuaLib.ipAddressCheck("10", ipToPing);
    if ((validations.is_fqdn_address (ipToPing) == false) and (validations.is_ipv4_address(ipToPing) == false) and (tonumber (ip6AddrCheck) == 1)) then        
	statusErrorMessage	 = "Invalid IP Format"
    else
    inputTable ["ping"] = "start"
    errorFlag, outputText = network.pingCmdSet(inputTable)
    if (errorFlag == returnCodes.SUCCESS) then 
        statusSuccessMessage = errorMap.errorStringGet (errorFlag)
    else 
        statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
    end
    web.goToPage (NextPage, true, true)

elseif (ButtonType and ButtonType == "traceroute") then
    inputTable = web.cgiToLuaTable(cgi)
    local ipToTraceRoute = inputTable["networkTools.IpAddress"]
    local ip6AddrCheck = validationsLuaLib.ipAddressCheck("10", ipToTraceRoute);
     
 
    if ((validations.is_fqdn_address (ipToTraceRoute) == false) and (validations.is_ipv4_address(ipToTraceRoute) == false) and (tonumber (ip6AddrCheck) == 1)) then
       NextPage = "networkTools"
       statusErrorMessage  = "Invalid IP Format"
    else
    inputTable ["traceroute"] = "start"
    errorFlag, outputText = network.traceRouteStatusSet (inputTable)
    if (errorFlag == returnCodes.SUCCESS) then 
        statusSuccessMessage = errorMap.errorStringGet (errorFlag)
    else 
        statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
 end
    web.goToPage (NextPage, true, true)

elseif (ButtonType and ButtonType == "dnslookup") then
    inputTable = web.cgiToLuaTable(cgi)
    local internetNameToNsLookup = inputTable["networkTools.domainName"]
 	
    if ((validations.is_fqdn_address (internetNameToNsLookup) == false)) then
       NextPage = "networkTools"
       statusMessage = "Invalid DNS Name"
    else
    inputTable ["dns.status"] = "start"
    errorFlag, dnsLookupOutputText = network.dnsLookupSectionSet (inputTable)
    if (errorFlag == returnCodes.SUCCESS) then 
        statusSuccessMessage = errorMap.errorStringGet (errorFlag)
    else 
        statusErrorMessage = errorMap.errorStringGet (errorFlag)
    end
end
    outputText = ""
    web.goToPage (NextPage, true, true)
else
    if (outputText == nil) then
        outputText = ""
    end
    if (dnsLookupOutputText == nil) then
        dnsLookupOutputText = ""
    end
cgilua.header ("Content-Type","text/html; charset=UTF-8")

LANG_LOCALE = "11766,10464,13037,10544,10796,10805,11631,10545,11388,11941,13121,12291,11282,12289,11279"
?>

<!DOCTYPE html>
<html>
       <head>
              <meta http-equiv="Content-Language" content="en-us">
              <title>$|COMPANY_NAME|$ : $|APP_NAME|$</title>
              <!--
              Copyright (c) 2012 - 2013 TeamF1, Inc. (www.TeamF1.com)
              All rights reserved.
              -->

              <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
              <meta http-equiv="content-type" content="text/html; charset=utf-8" />
              <link rel="stylesheet" type="text/css" href="css/style.css" />
              <link rel="stylesheet" type="text/css" href="css/buttons.css" />
              <link rel="stylesheet" type="text/css" href="css/menu.css" />
              <script type="text/javascript" language="javascript" src="js/jquery-1.8.0.min.js"></script>
              <?lua web.includeMenu("metaInclude.html")?>
       </head>
       <body>
              <table border="0" cellpadding="0" cellspacing="0" width="100%">
                     <tr>
                            <td class="header" valign="top" align="center">
                            <?lua web.includeMenu("header.html")?></td>
                     </tr>
                     <tr>
                            <td valign="top" align="center">
                            <div class="midWidth">
                                   <script language="JavaScript">
                                          mmSel("mainMenu6");
                                   </script>
                                   <!-- Status message place holder... [ 1. for error use "msgError" 2. for information use "msgInfo" 3. for sucess use "msgSuccess" CSS classes ]
                                   <div class="msgError">
                                   <p>Error Message Place Holder.</p>
                                   </div>
                                   -->
                                   	<?lua if (statusSuccessMessage ~= returnCodes.NIL) then ?>
			                            <div class="msgSuccess">
                                            <p>$| statusSuccessMessage or '' |$</p>
			                            </div>
		   	                            <?lua elseif (statusErrorMessage ~= returnCodes.NIL) then?>
			                            <div class="msgError">
                                            <p>$| statusErrorMessage or '' |$</p>
                                        </div> 
                                        <?lua  end?>
                                   <div align="left">
                                          <nav class="nav-bg">
                                                 <ul class="menu">
                                                        <li class="current">
                                                               <a href="?page=networkTools.html">$| LANG_LOCALE['11766'] |$</a>
                                                        </li>
                                                        <li>
                                                               <a href="?page=capturePackets.html">$| LANG_LOCALE['10464'] |$</a>
                                                        </li>
                                                        <li>
                                                               <a href="?page=systemCheck.html">$| LANG_LOCALE['13037'] |$</a>
                                                        </li>
                                                 </ul>
                                          </nav>
                                   </div>
                                   <div class="FL2">
                                          <p class="hint">
                                           $| helpHintText |$                                          </p>
                                   </div>
                                   <h1>$| LANG_LOCALE['11766'] |$</h1>
                                   <div class="midArea">
                                          <div align="left">
                                                 <form name="tf1_frmNetworkTools"
                                id="tf1_frmNetworkTools" action="platform.cgi" method="post">
                                                 <input type="hidden" name="thispage" id="thispage" value="networkTools.html">
                                                        <h2>$| LANG_LOCALE['10545'] |$</h2>
                                                        <div class="configRow">
                                                               <label> $| LANG_LOCALE['11388'] |$ </label>
                                                               <input type="text" id="tf1_txtIpaddr" name="networkTools.IpAddress" size = "32" maxlength = "40" onKeyDown="if (event.keyCode == 9) { return (ipAddrValidate (this, false, true, '', '', true) || validateFQDN(this.id)); }" value = "www.dlink.com">
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                        <div class="submitRow">
                                                               <input type="submit" onclick="return validateDiagnostics(1)" class="btnSubmit" title="$| LANG_LOCALE['11941'] |$" value="$| LANG_LOCALE['11941'] |$" id="btSave" name = "button.ping.networkTools">
                                                               <input type="submit" onclick="return validateDiagnostics(2)" class="btnSubmit" title="$| LANG_LOCALE['13121'] |$" value="$| LANG_LOCALE['13121'] |$" id="btSave" name = "button.traceroute.networkTools">
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                        <div class="configRow">
                                                               <label> $| LANG_LOCALE['10544'] |$ </label>
                                                               <textarea class="one" name="1" id>
                                                                    $| outputText |$
                                                               </textarea>
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                        <h2>$| LANG_LOCALE['10796'] |$</h2>
                                                        <div class="configRow">
                                                               <label> $| LANG_LOCALE['10805'] |$ </label>
                                                               <input type="text" id="tf1_txtIntName" name="networkTools.domainName" onKeyDown="if (event.keyCode == 13) { return false; }">
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                        <div class="submitRow">
                                                               <input type="submit" onclick="return validateDiagnostics(3)" class="btnSubmit" title="$| LANG_LOCALE['11631'] |$" value="$| LANG_LOCALE['11631'] |$" id="btSave" name="button.dnslookup.networkTools">
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                        <div class="configRow">
                                                               <label> $| LANG_LOCALE['10544'] |$ </label>
                                                               <textarea class="one" name="1" id>
                                                                    $| dnsLookupOutputText |$
                                                               </textarea>
                                                        </div>
                                                        <div class="break">
                                                               &nbsp;
                                                        </div>
                                                 </form>
                                          </div>
                                   </div>
                            </div></td>
                     </tr>
                     <tr>
                            <td>
                            <?lua web.includeMenu("footer.html")?></td>
                     </tr>
              </table>
              <script type="text/javascript" language="javascript" src="js/mis.js"></script>
              <script type="text/javascript" language="javascript" src="js/textValidations.js"></script>
              <script type="text/javascript" language="javascript" src="js/ipv4AddrValidations.js"></script>
              <script type="text/javascript" language="javascript" src="js/mgmt.js"></script>
              <script type="text/javascript" language="javascript" src="js/networkTools.js"></script>
       </body>
</html>
<?lua end ?>

